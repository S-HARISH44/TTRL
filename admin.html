<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TTRL | Mission Control</title>
    
    <!-- Fonts: Tech & Data -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700;800&family=Rajdhani:wght@500;600;700&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Three.js for Globe -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    
    <!-- GSAP for Animations -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <!-- SHADERS FOR DOTTED GLOBE -->
    <script type="x-shader/x-fragment" id="fragment-shader-map">
        uniform sampler2D u_map_tex;
        varying float vOpacity;
        varying vec2 vUv;

        void main() {
            vec3 color = texture2D(u_map_tex, vUv).rgb;
            float gray = dot(color, vec3(0.299, 0.587, 0.114));
            
            // INCREASED BRIGHTNESS: Multiplied by 4.0 and added base luminance
            vec3 techColor = vec3(0.5, 0.96, 1.0) * gray * 4.0;
            
            // Dot Shape
            color -= .2 * length(gl_PointCoord.xy - vec2(.5));
            float dot = 1. - smoothstep(.38, .4, length(gl_PointCoord.xy - vec2(.5)));
            if (dot < 0.5) discard;
            
            gl_FragColor = vec4(techColor, dot * vOpacity);
        }
    </script>

    <script type="x-shader/x-vertex" id="vertex-shader-map">
        uniform sampler2D u_map_tex;
        uniform float u_dot_size;
        uniform float u_time_since_click;
        uniform vec3 u_pointer;

        varying float vOpacity;
        varying vec2 vUv;

        void main() {
            vUv = uv;
            // Mask with texture brightness (Land vs Sea)
            float visibility = step(.2, texture2D(u_map_tex, uv).r);
            gl_PointSize = visibility * u_dot_size;

            // Fade out dots in back
            vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);
            vOpacity = (1. / length(mvPosition.xyz) - .7);
            vOpacity = clamp(vOpacity, .1, 1.); // Increased min opacity for brightness

            gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.);
        }
    </script>

    <style>
        :root {
            /* --- COLOR PALETTE --- */
            --bg-body: #050505;
            --bg-panel: #0f1012;
            --bg-panel-hover: #16171a;
            --bg-sidebar: #09090b;
            
            --border-dim: rgba(255, 255, 255, 0.08);
            --border-light: rgba(255, 255, 255, 0.15);
            
            --accent-cyan: #00f0ff;
            --accent-red: #ff3b3b;
            --accent-green: #00ff9d;
            --accent-yellow: #fcee0a;
            --accent-purple: #bd00ff;
            
            --text-primary: #ffffff;
            --text-secondary: #9ca3af;
            --text-muted: #4b5563;

            /* --- FONTS --- */
            --font-display: 'Chakra Petch', sans-serif;
            --font-ui: 'Rajdhani', sans-serif;
            --font-data: 'JetBrains Mono', monospace;

            /* --- DIMENSIONS --- */
            --sidebar-width: 240px;
            --sidebar-width-collapsed: 72px;
            --header-height: 70px;
        }

        /* --- GLOBAL RESET --- */
        * { box-sizing: border-box; outline: none; margin: 0; padding: 0; }
        
        body {
            background-color: var(--bg-body);
            color: var(--text-primary);
            font-family: var(--font-ui);
            height: 100vh;
            overflow: hidden;
            /* Updated Background to match Login Screen with overlay for readability */
            background-image: 
                linear-gradient(rgba(5, 5, 7, 0.92), rgba(5, 5, 7, 0.98)),
                url('https://raw.githubusercontent.com/S-HARISH44/TTRL/452f1b2138a6e81e13d957a448e4de317d9f8201/RESOURCES/f1-cars-race-track-3840x2160-13489.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-body); }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-cyan); }

        /* --- LAYOUT --- */
        .app-layout {
            display: flex;
            height: 100vh;
            width: 100vw;
            opacity: 0; /* Hidden until auth */
            transition: opacity 0.5s ease;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border-dim);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 50;
        }
        .sidebar.collapsed { width: var(--sidebar-width-collapsed); }

        .logo-area {
            height: var(--header-height);
            display: flex;
            align-items: center;
            padding: 0 20px;
            border-bottom: 1px solid var(--border-dim);
            gap: 12px;
            overflow: hidden;
        }
        .logo-img { height: 32px; width: auto; object-fit: contain; }
        .logo-text { font-family: var(--font-display); font-weight: 700; font-size: 1.2rem; letter-spacing: 1px; white-space: nowrap; color: #fff; }
        .sidebar.collapsed .logo-text { opacity: 0; pointer-events: none; }

        .nav-links { flex: 1; padding: 20px 12px; overflow-y: auto; display: flex; flex-direction: column; gap: 4px; }

        .nav-group-label {
            font-size: 0.65rem;
            color: var(--text-muted);
            font-weight: 700;
            padding: 15px 16px 5px;
            letter-spacing: 1px;
            font-family: var(--font-data);
            opacity: 0.7;
        }
        .sidebar.collapsed .nav-group-label { display: none; }

        .nav-btn {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            color: var(--text-secondary);
            text-decoration: none;
            border-radius: 6px;
            transition: all 0.2s;
            cursor: pointer;
            font-weight: 600;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }
        .nav-btn i { width: 24px; text-align: center; font-size: 1.1rem; margin-right: 12px; transition: color 0.2s; }
        .nav-btn span { white-space: nowrap; transition: opacity 0.2s; }
        .sidebar.collapsed .nav-btn span { opacity: 0; width: 0; }
        .sidebar.collapsed .nav-btn i { margin-right: 0; }
        .nav-btn:hover { background: var(--bg-panel-hover); color: #fff; }
        .nav-btn.active { background: rgba(0, 240, 255, 0.08); color: var(--accent-cyan); border: 1px solid rgba(0, 240, 255, 0.2); }
        .nav-btn.active::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 3px; background: var(--accent-cyan); box-shadow: 0 0 10px var(--accent-cyan); }

        .user-panel {
            padding: 20px;
            border-top: 1px solid var(--border-dim);
            background: rgba(0,0,0,0.2);
        }
        .user-panel-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
        .user-name { font-family: var(--font-display); font-size: 0.9rem; font-weight: 700; color: #fff; white-space: nowrap; }
        .user-role { font-size: 0.7rem; color: var(--accent-green); font-family: var(--font-data); }
        .sidebar.collapsed .user-panel-row { display: none; }

        /* --- MAIN CONTENT --- */
        .main-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* --- HEADER BAR --- */
        .top-bar {
            height: var(--header-height);
            border-bottom: 1px solid var(--border-dim);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            background: rgba(5, 5, 5, 0.8);
            backdrop-filter: blur(10px);
            z-index: 40;
        }
        .toggle-sidebar { background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 1.2rem; }
        .toggle-sidebar:hover { color: #fff; }

        .season-control {
            display: flex;
            align-items: center;
            gap: 15px;
            background: var(--bg-panel);
            padding: 5px 15px;
            border: 1px solid var(--border-dim);
            border-radius: 4px;
        }
        .season-label { font-family: var(--font-data); font-size: 0.75rem; color: var(--text-muted); font-weight: 700; }
        .season-input { background: none; border: none; color: var(--accent-cyan); font-family: var(--font-display); font-weight: 700; font-size: 1rem; text-transform: uppercase; width: 100px; text-align: center; }
        .season-input:focus { border-bottom: 1px solid var(--accent-cyan); }

        .action-cluster { display: flex; gap: 10px; }
        
        .btn {
            background: var(--bg-panel); border: 1px solid var(--border-dim); color: var(--text-secondary);
            padding: 8px 16px; font-family: var(--font-ui); font-weight: 700; font-size: 0.8rem;
            text-transform: uppercase; letter-spacing: 0.5px; cursor: pointer; transition: all 0.2s;
            border-radius: 4px; display: inline-flex; align-items: center; gap: 8px;
        }
        .btn:hover { border-color: var(--text-secondary); color: #fff; background: var(--bg-panel-hover); }
        .btn-primary { background: var(--accent-cyan); color: #000; border: none; }
        .btn-primary:hover { background: #fff; box-shadow: 0 0 15px var(--accent-cyan); }
        .btn-danger { color: var(--accent-red); border-color: rgba(255, 59, 59, 0.3); background: rgba(255, 59, 59, 0.05); }
        .btn-danger:hover { background: var(--accent-red); color: #fff; }
        .btn-success { color: var(--accent-green); border-color: rgba(0, 255, 157, 0.3); background: rgba(0, 255, 157, 0.05); }
        .btn-success:hover { background: var(--accent-green); color: #000; }

        /* --- WORKSPACE --- */
        .workspace { flex: 1; padding: 30px; overflow-y: auto; position: relative; }
        .section { display: none; animation: slideUp 0.3s ease-out; }
        .section.active { display: block; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- CARDS & PANELS --- */
        .panel {
            background: var(--bg-panel); border: 1px solid var(--border-dim); border-radius: 8px;
            padding: 24px; margin-bottom: 24px; position: relative;
        }
        .panel::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 2px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
        }
        .panel-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;
            border-bottom: 1px solid var(--border-dim); padding-bottom: 15px;
        }
        .panel-title { font-family: var(--font-display); font-size: 1.1rem; font-weight: 600; color: #fff; display: flex; align-items: center; gap: 10px; }
        .panel-title i { color: var(--text-muted); font-size: 0.9rem; }

        /* --- DASHBOARD LAYOUT (SPLIT) --- */
        .dashboard-split {
            display: grid;
            grid-template-columns: 3fr 2fr; /* CHANGED: Left side 60%, Right Side 40% (Globe Smaller) */
            gap: 30px;
            height: calc(100vh - 140px);
            min-height: 600px;
        }

        .dash-left {
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding-right: 5px;
        }

        .dash-right {
            position: relative;
            background: rgba(0,0,0,0.4); /* Transparent to let bg texture show through */
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border-dim);
        }

        #globeContainer { width: 100%; height: 100%; }

        /* STAT CARDS */
        .stat-grid-compact {
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px;
        }
        
        .stat-card {
            background: linear-gradient(145deg, #0e0f11, #09090b); border: 1px solid var(--border-dim);
            padding: 20px; border-radius: 8px; position: relative; overflow: hidden; transition: transform 0.2s;
        }
        .stat-card:hover { transform: translateY(-2px); border-color: var(--border-light); }
        .stat-icon { position: absolute; right: -10px; top: -10px; font-size: 4rem; opacity: 0.05; transform: rotate(15deg); }
        .stat-label { font-family: var(--font-data); font-size: 0.7rem; color: var(--text-secondary); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 6px; }
        .stat-value { font-family: var(--font-display); font-size: 2rem; font-weight: 700; color: #fff; line-height: 1; }
        .stat-footer { margin-top: 10px; font-size: 0.75rem; color: var(--text-muted); display: flex; align-items: center; gap: 6px; }
        .stat-footer.positive { color: var(--accent-green); }
        .stat-footer.highlight { color: var(--accent-cyan); }

        /* GLOBE TOOLTIP CARD */
        #globe-tooltip {
            position: absolute;
            top: 0; left: 0;
            background: rgba(8, 8, 10, 0.9);
            border: 1px solid var(--accent-cyan);
            border-left: 4px solid var(--accent-cyan);
            padding: 15px;
            border-radius: 0 4px 4px 0;
            pointer-events: none;
            display: none;
            z-index: 100;
            width: 220px;
            box-shadow: 0 0 30px rgba(0, 240, 255, 0.15);
            backdrop-filter: blur(8px);
        }
        #globe-tooltip h3 { margin: 0 0 5px 0; font-family: var(--font-display); font-size: 1.1rem; color: #fff; text-transform: uppercase; }
        #globe-tooltip p { margin: 0; font-family: var(--font-data); font-size: 0.8rem; color: var(--accent-cyan); }
        #globe-tooltip .coords { margin-top: 5px; font-size: 0.7rem; color: #666; font-family: var(--font-data); }

        /* --- FORMS & INPUTS --- */
        .input-group { margin-bottom: 15px; }
        .input-label { display: block; font-family: var(--font-data); font-size: 0.7rem; color: var(--text-secondary); margin-bottom: 6px; text-transform: uppercase; }
        .form-control { width: 100%; background: #050505; border: 1px solid var(--border-dim); color: #fff; padding: 10px 14px; font-family: var(--font-ui); font-size: 0.95rem; border-radius: 4px; transition: border 0.2s; }
        .form-control:focus { border-color: var(--accent-cyan); }

        /* --- GRID/LIST VIEWS --- */
        .data-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 16px; }
        .driver-card { background: var(--bg-panel); border: 1px solid var(--border-dim); border-left: 4px solid var(--team-color, #333); border-radius: 6px; padding: 16px; display: flex; align-items: center; justify-content: space-between; transition: all 0.2s; }
        .driver-card:hover { background: var(--bg-panel-hover); }
        .driver-info h4 { font-family: var(--font-display); font-size: 1.1rem; margin: 0; }
        .driver-info p { font-family: var(--font-data); font-size: 0.75rem; color: var(--text-secondary); margin: 4px 0 0; text-transform: uppercase; }
        .icon-btn { background: none; border: 1px solid var(--border-dim); color: var(--text-secondary); width: 28px; height: 28px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; transition: 0.2s; }
        .icon-btn:hover { border-color: #fff; color: #fff; }
        .icon-btn.delete:hover { border-color: var(--accent-red); color: var(--accent-red); }

        /* --- TABLES --- */
        .tech-table { width: 100%; border-collapse: separate; border-spacing: 0; font-family: var(--font-ui); font-size: 0.9rem; }
        .tech-table th { text-align: left; padding: 12px 16px; color: var(--text-secondary); font-family: var(--font-data); font-size: 0.75rem; text-transform: uppercase; border-bottom: 1px solid var(--border-dim); }
        .tech-table td { padding: 12px 16px; border-bottom: 1px solid rgba(255,255,255,0.03); color: #e5e5e5; }
        .tech-table tr:hover td { background: rgba(255,255,255,0.02); }

        /* --- MODALS --- */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 100; display: none; align-items: center; justify-content: center; }
        .modal-box { background: #0e0f11; border: 1px solid var(--border-light); width: 90%; max-width: 450px; padding: 30px; border-radius: 8px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); text-align: center; }
        .modal-title { font-family: var(--font-display); font-size: 1.4rem; color: #fff; margin-bottom: 10px; }

        /* --- LOGIN SCREEN --- */
        #login-screen { position: fixed; inset: 0; z-index: 999; background: #000; display: flex; align-items: center; justify-content: center; background-image: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.9)), url('https://raw.githubusercontent.com/S-HARISH44/TTRL/452f1b2138a6e81e13d957a448e4de317d9f8201/RESOURCES/f1-cars-race-track-3840x2160-13489.jpg'); background-size: cover; background-position: center; }
        .login-card { width: 400px; padding: 40px; background: rgba(10, 10, 12, 0.95); border: 1px solid var(--border-light); border-top: 2px solid var(--accent-cyan); backdrop-filter: blur(20px); box-shadow: 0 0 50px rgba(0,0,0,0.8); border-radius: 8px; text-align: center; }
        .login-logo { height: 60px; margin-bottom: 20px; }

        /* Toast */
        .toast { position: fixed; bottom: 30px; right: 30px; background: #111; border: 1px solid var(--accent-cyan); border-left-width: 4px; padding: 15px 25px; color: #fff; transform: translateY(100px); opacity: 0; transition: 0.3s; z-index: 200; font-family: var(--font-data); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .toast.show { transform: translateY(0); opacity: 1; }

        /* --- RESPONSIVE --- */
        @media (max-width: 1100px) {
            .dashboard-split { grid-template-columns: 1fr; height: auto; }
            .dash-right { height: 500px; order: -1; /* Globe on top for mobile */ }
        }
        @media (max-width: 900px) {
            .app-layout { flex-direction: column; height: auto; min-height: 100vh; }
            .sidebar { width: 100%; height: auto; border-right: none; border-bottom: 1px solid var(--border-dim); }
            .sidebar.collapsed .nav-links { display: none; }
            .main-wrapper { height: auto; overflow: visible; }
            .top-bar { padding: 0 15px; flex-direction: column; height: auto; padding-bottom: 15px; gap: 10px; }
            .action-cluster { flex-wrap: wrap; justify-content: center; }
            .nav-links { flex-direction: row; overflow-x: auto; padding: 10px; }
            .nav-btn span { display: none; } 
            .nav-btn i { margin: 0; font-size: 1.2rem; }
            .workspace { padding: 15px; }
        }
    </style>
</head>
<body>

    <!-- LOGIN OVERLAY -->
    <div id="login-screen">
        <div class="login-card">
            <img src="https://raw.githubusercontent.com/S-HARISH44/TTRL/452f1b2138a6e81e13d957a448e4de317d9f8201/RESOURCES/image.png" class="login-logo" alt="TTRL">
            <h2 class="modal-title">SYSTEM UPLINK</h2>
            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 30px;">PITWALL CONTROL INTERFACE</p>
            <button class="btn btn-primary" onclick="loginWithGoogle()" style="width: 100%; justify-content: center; margin-bottom: 20px; font-size: 1rem;">
                <i class="fab fa-google"></i> AUTHENTICATE WITH GOOGLE
            </button>
            <div style="display: flex; align-items: center; gap: 10px; margin: 20px 0;">
                <div style="flex:1; height:1px; background:var(--border-dim)"></div>
                <span style="font-size:0.7rem; color:var(--text-muted)">OR MANUAL OVERRIDE</span>
                <div style="flex:1; height:1px; background:var(--border-dim)"></div>
            </div>
            <input type="email" id="loginEmail" class="form-control" placeholder="OPERATOR ID" style="margin-bottom: 10px; text-align:center;">
            <input type="password" id="loginPass" class="form-control" placeholder="ACCESS KEY" style="margin-bottom: 20px; text-align:center;">
            <button class="btn" onclick="checkLogin()" style="width: 100%; justify-content: center; border-color: var(--accent-cyan); color: var(--accent-cyan);">
                INITIALIZE CONNECTION
            </button>
            <div id="login-msg" style="margin-top: 15px; color: var(--accent-red); font-size: 0.8rem; font-family: var(--font-data);"></div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div class="app-layout" id="main-interface" style="display:none;">
        
        <!-- SIDEBAR -->
        <nav class="sidebar" id="appSidebar">
            <div class="logo-area">
                <img src="https://raw.githubusercontent.com/S-HARISH44/TTRL/452f1b2138a6e81e13d957a448e4de317d9f8201/RESOURCES/image.png" class="logo-img" alt="Logo">
                <div class="logo-text">PITWALL</div>
            </div>
            
            <div class="nav-links">
                <!-- GROUP 1: MONITORING -->
                <div class="nav-group-label">OVERVIEW</div>
                <a class="nav-btn active" onclick="switchTab('dashboard')"><i class="fas fa-gauge-high"></i> <span>DASHBOARD</span></a>
                <a class="nav-btn" onclick="switchTab('live-view')"><i class="fas fa-tower-broadcast"></i> <span>LIVE TELEMETRY</span></a>
                <a class="nav-btn" onclick="switchTab('driver-stats')"><i class="fas fa-chart-pie"></i> <span>ANALYTICS</span></a>

                <!-- GROUP 2: MANAGEMENT -->
                <div class="nav-group-label">OPERATIONS</div>
                <a class="nav-btn" onclick="switchTab('season-setup')"><i class="fas fa-calendar-days"></i> <span>CALENDAR EDITOR</span></a>
                <a class="nav-btn" onclick="switchTab('manage-drivers')"><i class="fas fa-user-plus"></i> <span>DRIVER ONBOARD</span></a>
                <a class="nav-btn" onclick="switchTab('driver-editor')"><i class="fas fa-user-pen"></i> <span>DRIVER EDITOR</span></a>
                <a class="nav-btn" onclick="switchTab('race-director')"><i class="fas fa-flag-checkered"></i> <span>RACE EDITOR</span></a>
            </div>

            <div class="user-panel">
                <div class="user-panel-row">
                    <div class="user-name" id="userName">OPERATOR</div>
                    <div class="user-role">ADMIN</div>
                </div>
                <button class="btn btn-danger" onclick="logout()" style="width: 100%; justify-content: center; font-size: 0.7rem;">
                    <i class="fas fa-power-off"></i> DISCONNECT
                </button>
            </div>
        </nav>

        <!-- CONTENT WRAPPER -->
        <div class="main-wrapper">
            
            <!-- TOP BAR -->
            <header class="top-bar">
                <div style="display: flex; align-items: center; gap: 20px;">
                    <button class="toggle-sidebar" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
                    <div class="season-control">
                        <span class="season-label">ACTIVE SEASON:</span>
                        <input type="text" id="seasonInput" class="season-input" value="season_1" onchange="changeSeason()">
                        <button class="icon-btn" onclick="changeSeason()"><i class="fas fa-sync-alt"></i></button>
                    </div>
                    <div id="knownSeasonsList" style="font-family: var(--font-data); font-size: 0.7rem; color: var(--text-muted);"></div>
                </div>
                <div class="action-cluster">
                    <button class="btn" onclick="openMigrationModal()"><i class="fas fa-exchange-alt"></i> MIGRATE</button>
                    <button class="btn" onclick="triggerImport()"><i class="fas fa-file-import"></i> IMPORT CSV</button>
                    <button class="btn" onclick="exportData()"><i class="fas fa-download"></i> BACKUP</button>
                    <input type="file" id="csvFile" accept=".csv" style="display:none" onchange="handleFileSelect(this)">
                </div>
            </header>

            <!-- WORKSPACE -->
            <div class="workspace">
                
                <!-- 1. DASHBOARD -->
                <div id="dashboard" class="section active">
                    <div class="panel-header" style="border:none; margin-bottom: 10px;">
                        <div class="panel-title" style="font-size: 1.5rem;">MISSION OVERVIEW</div>
                        <span class="user-role" id="dashNextDate">SEASON ACTIVE</span>
                    </div>

                    <!-- SPLIT LAYOUT -->
                    <div class="dashboard-split">
                        
                        <!-- LEFT COLUMN: STATS -->
                        <div class="dash-left">
                            <div class="stat-grid-compact">
                                <!-- Drivers -->
                                <div class="stat-card">
                                    <i class="fas fa-users stat-icon"></i>
                                    <div class="stat-label">GRID SIZE</div>
                                    <div class="stat-value" id="dashDriverCount">0</div>
                                    <div class="stat-footer positive"><i class="fas fa-check"></i> Active</div>
                                </div>
                                
                                <!-- Tracks -->
                                <div class="stat-card">
                                    <i class="fas fa-map-location-dot stat-icon"></i>
                                    <div class="stat-label">CALENDAR</div>
                                    <div class="stat-value" id="dashTrackCount">0</div>
                                    <div class="stat-footer highlight"><i class="fas fa-flag"></i> Races</div>
                                </div>

                                <!-- Leader -->
                                <div class="stat-card" style="border-color: var(--accent-cyan); box-shadow: 0 0 20px rgba(0,240,255,0.05);">
                                    <i class="fas fa-trophy stat-icon" style="color: var(--accent-cyan); opacity: 0.1;"></i>
                                    <div class="stat-label" style="color: var(--accent-cyan);">LEADER</div>
                                    <div class="stat-value" id="dashLeader" style="font-size:1.5rem;">--</div>
                                    <div class="stat-footer highlight" id="dashLeaderPts">0 PTS</div>
                                </div>

                                <!-- Constructors -->
                                <div class="stat-card" style="border-color: var(--accent-red); box-shadow: 0 0 20px rgba(255,59,59,0.05);">
                                    <i class="fas fa-cogs stat-icon" style="color: var(--accent-red); opacity: 0.1;"></i>
                                    <div class="stat-label" style="color: var(--accent-red);">TOP TEAM</div>
                                    <div class="stat-value" id="dashTeamLeader" style="font-size:1.5rem;">--</div>
                                    <div class="stat-footer highlight" style="color: var(--accent-red);" id="dashTeamPts">0 PTS</div>
                                </div>
                            </div>

                            <!-- Progress -->
                            <div class="stat-card">
                                <div class="stat-label">SEASON PROGRESS</div>
                                <div style="display:flex; justify-content:space-between; align-items:end; margin-bottom:10px;">
                                    <div class="stat-value" id="dashProgressPct">0%</div>
                                    <div class="stat-footer" id="dashRacesDone">0 / 0 RACES</div>
                                </div>
                                <div style="width:100%; height:6px; background:#222; border-radius:4px; overflow:hidden;">
                                    <div id="dashProgressBar" style="width:0%; height:100%; background:var(--accent-green); box-shadow: 0 0 10px var(--accent-green); transition: width 1s ease;"></div>
                                </div>
                            </div>

                            <!-- Next Race / Last Winner -->
                            <div class="stat-grid-compact">
                                <div class="stat-card">
                                    <div class="stat-label">NEXT EVENT</div>
                                    <div class="stat-value" id="dashNextRace" style="font-size: 1.2rem;">--</div>
                                    <div class="stat-footer"><i class="far fa-clock"></i> Scheduled</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-label">LATEST VICTOR</div>
                                    <div class="stat-value" id="dashLastWinner" style="font-size: 1.2rem;">--</div>
                                    <div class="stat-footer" id="dashLastGP">WAITING</div>
                                </div>
                            </div>

                            <!-- Calendar List -->
                            <div class="panel" style="flex:1; margin:0; display:flex; flex-direction:column; min-height:200px;">
                                <div class="panel-title"><i class="far fa-calendar-alt"></i> SCHEDULE</div>
                                <div id="dashCalendarList" style="flex:1; margin-top: 15px; overflow-y: auto; font-family: var(--font-data); font-size: 0.8rem;"></div>
                            </div>
                        </div>

                        <!-- RIGHT COLUMN: GLOBE -->
                        <div class="dash-right">
                            <div id="globeContainer"></div>
                            <!-- Tooltip Card -->
                            <div id="globe-tooltip">
                                <h3 id="gt-title">TRACK NAME</h3>
                                <p id="gt-status">STATUS</p>
                                <div class="coords" id="gt-coords">LAT: 00.00 | LON: 00.00</div>
                            </div>
                            <div style="position:absolute; bottom:20px; right:20px; font-size:0.7rem; color:var(--text-muted); font-family: var(--font-data);">
                                [ SYSTEM: ONLINE ]<br>
                                ROTATE: DRAG<br>
                                INSPECT: HOVER
                            </div>
                        </div>

                    </div>
                </div>

                <!-- 2. SEASON CONFIG -->
                <div id="season-setup" class="section">
                    <div class="panel">
                        <div class="panel-header">
                            <div class="panel-title"><i class="fas fa-route"></i> CALENDAR CONFIGURATION</div>
                            <div class="action-cluster">
                                <button class="btn" onclick="toggleTrackSelectAll()">SELECT ALL</button>
                                <button class="btn btn-danger" onclick="deleteSelectedTracks()">DELETE</button>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 2fr 1fr auto; gap: 15px; margin-bottom: 25px; align-items: end;">
                            <div>
                                <label class="input-label">SELECT CIRCUIT</label>
                                <select id="trackSelector" class="form-control"><option>LOADING...</option></select>
                            </div>
                            <div>
                                <label class="input-label">RACE DATE</label>
                                <input type="date" id="newTrackDate" class="form-control">
                            </div>
                            <button class="btn btn-primary" onclick="addTrackConfig()" style="height: 42px;"><i class="fas fa-plus"></i></button>
                        </div>

                        <div id="trackConfigList" style="max-height: 500px; overflow-y: auto;"></div>
                    </div>
                </div>

                <!-- 3. MANAGE GRID -->
                <div id="manage-drivers" class="section">
                    <div class="panel">
                        <div class="panel-header">
                            <div class="panel-title"><i class="fas fa-users"></i> ACTIVE GRID</div>
                            <div class="action-cluster">
                                <button class="btn" onclick="toggleSelectAll()">SELECT ALL</button>
                                <button class="btn btn-danger" onclick="deleteSelectedDrivers()">DELETE SELECTED</button>
                            </div>
                        </div>
                        <div style="margin-bottom:20px; display:flex; gap:10px;">
                            <input type="text" id="newDriverName" class="form-control" placeholder="DRIVER NAME">
                            <select id="newDriverTeam" class="form-control"></select>
                            <button class="btn btn-primary" onclick="registerDriver()">ADD</button>
                        </div>
                        <div id="driverList" class="data-grid"></div>
                    </div>
                </div>

                <!-- 4. RACE DIRECTOR -->
                <div id="race-director" class="section">
                    <div class="panel">
                        <div class="panel-header"><div class="panel-title"><i class="fas fa-flag-checkered"></i> RACE CONTROL</div></div>
                        <div style="max-width: 400px; margin-bottom: 30px;">
                            <label class="input-label">SELECT EVENT TO GRADE</label>
                            <select id="raceDirectorTrackSelect" class="form-control" onchange="loadRaceGrid()"><option>Loading...</option></select>
                        </div>
                        <div id="raceDirectorGrid" style="display:none;">
                            <div class="data-grid" id="raceInputsContainer"></div>
                            <div style="margin-top: 30px; border-top: 1px solid var(--border-dim); padding-top: 20px; text-align: right;">
                                <button class="btn btn-success" onclick="saveRaceResults()"><i class="fas fa-save"></i> COMMIT RESULTS</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 5. DRIVER EDITOR -->
                <div id="driver-editor" class="section">
                    <div class="panel">
                        <div class="panel-title" style="margin-bottom: 20px;"><i class="fas fa-pen-to-square"></i> INDIVIDUAL ADJUSTMENT</div>
                        <div id="editorSelectionGrid" class="data-grid"></div>
                        <div id="editor-area" style="display:none;">
                            <div style="display:flex; align-items:center; gap: 20px; margin-bottom: 30px;">
                                <button class="btn" onclick="closeDriverEditor()"><i class="fas fa-arrow-left"></i> BACK</button>
                                <h2 id="editorDriverNameDisplay" style="font-family: var(--font-display); margin:0;">DRIVER</h2>
                            </div>
                            <div style="max-width: 400px; margin-bottom: 30px;">
                                <label class="input-label">MAIN TEAM CONTRACT</label>
                                <select id="editorMainTeam" class="form-control" onchange="updateMainTeam()"></select>
                                <input type="hidden" id="editorDriverIdHidden">
                            </div>
                            <div id="trackGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px;"></div>
                            <div style="margin-top: 30px; padding: 20px; background: rgba(0,0,0,0.3); border: 1px solid var(--border-dim); border-radius: 6px; display: flex; justify-content: space-between; align-items: center;">
                                <div style="font-size: 1.2rem; font-weight: bold;">TOTAL: <span id="calculatedTotal" style="color: var(--accent-cyan);">0</span> PTS</div>
                                <button class="btn btn-primary" onclick="saveAllChanges()">SAVE CHANGES</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 6. LIVE VIEW -->
                <div id="live-view" class="section">
                    <div class="dashboard-grid" style="grid-template-columns: 1fr 1fr;">
                        <div class="panel">
                            <div class="panel-title" style="color: var(--accent-cyan);"><i class="fas fa-trophy"></i> DRIVERS CHAMPIONSHIP</div>
                            <div style="margin-top: 20px;"><table class="tech-table"><thead><tr><th>POS</th><th>DRIVER</th><th style="text-align:right;">PTS</th></tr></thead><tbody id="liveDriversBody"></tbody></table></div>
                        </div>
                        <div class="panel">
                            <div class="panel-title" style="color: var(--accent-red);"><i class="fas fa-wrench"></i> CONSTRUCTORS CHAMPIONSHIP</div>
                            <div style="margin-top: 20px;"><table class="tech-table"><thead><tr><th>POS</th><th>TEAM</th><th style="text-align:right;">PTS</th></tr></thead><tbody id="liveConstructorsBody"></tbody></table></div>
                        </div>
                    </div>
                </div>

                <!-- 7. ANALYTICS -->
                <div id="driver-stats" class="section">
                    <div class="panel">
                        <div class="panel-header"><div class="panel-title"><i class="fas fa-chart-line"></i> PERFORMANCE ANALYTICS</div></div>
                        <div style="max-width: 400px; margin-bottom: 30px;"><select id="statsDriverSelect" class="form-control" onchange="viewDriverStats()"></select></div>
                        <div id="statsDisplay" style="display:none;">
                            <div style="display:flex; justify-content:space-between; align-items: flex-end; margin-bottom: 30px;">
                                <div><h1 id="statsDriverName" style="font-family: var(--font-display); font-size: 2.5rem; margin:0;">NAME</h1><div id="statsTeamName" style="color: var(--accent-cyan); font-family: var(--font-data);">TEAM</div></div>
                                <div class="stat-value" id="statPoints" style="color: var(--accent-yellow);">0 <span style="font-size: 1rem; color: #888;">PTS</span></div>
                            </div>
                            <div class="dashboard-grid" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 30px;">
                                <div class="stat-card" style="padding: 15px;"><div class="stat-label">WINS</div><div class="stat-value" id="statWins">0</div></div>
                                <div class="stat-card" style="padding: 15px;"><div class="stat-label">PODIUMS</div><div class="stat-value" id="statPodiums">0</div></div>
                                <div class="stat-card" style="padding: 15px;"><div class="stat-label">AVG FINISH</div><div class="stat-value" id="statAvg">0</div></div>
                                <div class="stat-card" style="padding: 15px;"><div class="stat-label">CONSISTENCY</div><div class="stat-value" id="statConsistency">0</div></div>
                            </div>
                            <div class="dashboard-grid" style="grid-template-columns: 1fr 1fr; margin-bottom: 30px;">
                                <div class="panel" style="margin:0; min-height: 300px;"><div class="panel-title" style="font-size: 0.9rem;">CUMULATIVE POINTS</div><div style="position: relative; height: 250px; width: 100%;"><canvas id="pointsChart"></canvas></div></div>
                                <div class="panel" style="margin:0; min-height: 300px;"><div class="panel-title" style="font-size: 0.9rem;">RACE RESULTS</div><div style="position: relative; height: 250px; width: 100%;"><canvas id="barChart"></canvas></div></div>
                            </div>
                            <div class="panel-title">SEASON HISTORY</div>
                            <table class="tech-table"><thead><tr><th>TRACK</th><th>POS</th><th>TEAM</th><th style="text-align:right;">PTS</th></tr></thead><tbody id="statsHistoryBody"></tbody></table>
                        </div>
                    </div>
                </div>

                <!-- IMPORT PREVIEW -->
                <div id="import-preview" class="section">
                    <div class="panel">
                        <div class="panel-header"><div class="panel-title" style="color: var(--accent-green);">IMPORT PREVIEW</div></div>
                        <div style="margin-bottom: 20px; font-family: var(--font-data);">DETECTED TRACKS: <span id="detectedTracksList" style="color: var(--accent-green);"></span></div>
                        <div style="max-height: 400px; overflow-y: auto; border: 1px solid var(--border-dim); margin-bottom: 20px;"><table class="tech-table"><thead><tr><th>DRIVER</th><th>TEAM</th><th>PTS</th><th>STATUS</th></tr></thead><tbody id="importTableBody"></tbody></table></div>
                        <div class="action-cluster" style="justify-content: flex-end;"><button class="btn" onclick="cancelImport()">CANCEL</button><button class="btn btn-success" onclick="commitImport()">CONFIRM IMPORT</button></div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- MODALS -->
    <div id="confirmModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title" style="color: var(--accent-red);">CONFIRM ACTION</div>
            <p id="modalMessage" style="color: var(--text-secondary); margin-bottom: 25px;">Are you sure?</p>
            <div style="display: flex; gap: 15px; justify-content: center;"><button id="btnConfirmYes" class="btn btn-danger">PROCEED</button><button onclick="closeModal()" class="btn">CANCEL</button></div>
        </div>
    </div>

    <div id="migrationModal" class="modal-overlay">
        <div class="modal-box" style="border-color: var(--accent-cyan);">
            <div class="modal-title" style="color: var(--accent-cyan);">DATA MIGRATION</div>
            <p style="color: var(--text-secondary); margin-bottom: 20px;">Transfer data between seasons.</p>
            <div style="text-align: left; margin-bottom: 15px;"><label class="input-label">SOURCE (COPY FROM)</label><input type="text" id="migrateSource" class="form-control" placeholder="e.g. season_1"></div>
            <div style="text-align: left; margin-bottom: 20px;"><label class="input-label">TARGET (PASTE TO)</label><input type="text" id="migrateTarget" class="form-control" placeholder="e.g. season_2"></div>
            <div style="text-align: left; margin-bottom: 25px; display: flex; align-items: center; gap: 10px;"><input type="checkbox" id="migrateDelete"><label for="migrateDelete" style="font-size: 0.8rem; color: #fff;">DELETE SOURCE AFTER COPY</label></div>
            <div style="display: flex; gap: 15px; justify-content: center;"><button onclick="performMigration()" class="btn btn-primary">TRANSFER</button><button onclick="document.getElementById('migrationModal').style.display='none'" class="btn">CANCEL</button></div>
            <div id="migrationStatus" style="margin-top: 15px; color: var(--accent-cyan); font-family: var(--font-data); font-size: 0.8rem;"></div>
        </div>
    </div>

    <div id="toast" class="toast">Notification</div>

    <!-- LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, getDoc, setDoc, getDocs, query, orderBy, onSnapshot, writeBatch, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyApUD33ao9DfFa8IAfA2qby3IFKhLtcNFU",
            authDomain: "ttrl-9f3ef.firebaseapp.com",
            projectId: "ttrl-9f3ef",
            storageBucket: "ttrl-9f3ef.firebasestorage.app",
            messagingSenderId: "51144639440",
            appId: "1:51144639440:web:8a027b773bc2cddefe2fd5"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let currentSeason = "season_1"; 
        let unsubscribe = null; 
        let knownSeasons = [];
        let activeTracks = []; 
        try { knownSeasons = JSON.parse(localStorage.getItem('ttrl_seasons')) || ['season_1']; } catch(e) { knownSeasons = ['season_1']; }

        const TEAMS = [
            {id:'red-bull-racing', name:'Red Bull'}, {id:'ferrari', name:'Ferrari'}, {id:'mercedes', name:'Mercedes'},
            {id:'mclaren', name:'McLaren'}, {id:'aston-martin', name:'Aston Martin'}, {id:'alpine', name:'Alpine'},
            {id:'williams', name:'Williams'}, {id:'racing-bulls', name:'Racing Bulls'}, {id:'kick-sauber', name:'Kick Sauber'},
            {id:'haas', name:'Haas'}, {id:'reserve', name:'Reserve'}
        ];

        const TEAM_COLORS = {
            "red-bull-racing": "#3671C6", "ferrari": "#E80020", "mercedes": "#27F4D2", "mclaren": "#FF8000",
            "aston-martin": "#229971", "alpine": "#0093CC", "williams": "#64C4FF", "racing-bulls": "#6692FF",
            "kick-sauber": "#52E252", "haas": "#B6BABD", "reserve": "#666666"
        };

        const MASTER_TRACK_LIST = [
            { id: "bahrain", name: "Bahrain GP" }, { id: "saudi_arabia", name: "Saudi Arabian GP" }, { id: "australia", name: "Australian GP" },
            { id: "japan", name: "Japanese GP" }, { id: "china", name: "Chinese GP" }, { id: "miami", name: "Miami GP" },
            { id: "emilia_romagna", name: "Emilia Romagna GP" }, { id: "monaco", name: "Monaco GP" }, { id: "canada", name: "Canadian GP" },
            { id: "spain", name: "Spanish GP" }, { id: "austria", name: "Austrian GP" }, { id: "uk", name: "British GP" },
            { id: "hungary", name: "Hungarian GP" }, { id: "belgium", name: "Belgian GP" }, { id: "netherlands", name: "Dutch GP" },
            { id: "italy", name: "Italian GP" }, { id: "azerbaijan", name: "Azerbaijan GP" }, { id: "singapore", name: "Singapore GP" },
            { id: "usa", name: "United States GP" }, { id: "mexico", name: "Mexico City GP" }, { id: "brazil", name: "SÃ£o Paulo GP" },
            { id: "las_vegas", name: "Las Vegas GP" }, { id: "qatar", name: "Qatar GP" }, { id: "abu_dhabi", name: "Abu Dhabi GP" }
        ];

        // --- COORDINATES FOR GLOBE ---
        const TRACK_COORDS = {
            "bahrain": {lat: 26.03, lon: 50.51}, "saudi_arabia": {lat: 21.54, lon: 39.17}, "australia": {lat: -37.84, lon: 144.96},
            "japan": {lat: 34.84, lon: 136.54}, "china": {lat: 31.33, lon: 121.22}, "miami": {lat: 25.95, lon: -80.23},
            "emilia_romagna": {lat: 44.34, lon: 11.71}, "monaco": {lat: 43.73, lon: 7.42}, "canada": {lat: 45.50, lon: -73.52},
            "spain": {lat: 41.57, lon: 2.26}, "austria": {lat: 47.21, lon: 14.76}, "uk": {lat: 52.07, lon: -1.01},
            "hungary": {lat: 47.58, lon: 19.24}, "belgium": {lat: 50.43, lon: 5.97}, "netherlands": {lat: 52.38, lon: 4.54},
            "italy": {lat: 45.62, lon: 9.28}, "azerbaijan": {lat: 40.37, lon: 49.85}, "singapore": {lat: 1.29, lon: 103.85},
            "usa": {lat: 30.13, lon: -97.64}, "mexico": {lat: 19.40, lon: -99.09}, "brazil": {lat: -23.70, lon: -46.69},
            "las_vegas": {lat: 36.11, lon: -115.17}, "qatar": {lat: 25.48, lon: 51.45}, "abu_dhabi": {lat: 24.46, lon: 54.60}
        };

        let driversCache = {};
        let allDrivers = [];
        let pendingImportData = [];
        let pendingImportTracks = new Set();
        let statsChart = null;
        let barChart = null;

        let scene, camera, renderer, globe, controls, globeMarkers = [];
        const globeContainer = document.getElementById('globeContainer');
        let clock = new THREE.Clock();

        window.showToast = (msg) => {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        };

        window.customConfirm = (msg, onYes) => {
            const m = document.getElementById('confirmModal');
            document.getElementById('modalMessage').innerText = msg;
            m.style.display = 'flex';
            document.getElementById('btnConfirmYes').onclick = () => { m.style.display = 'none'; onYes(); };
        };
        window.closeModal = () => document.getElementById('confirmModal').style.display = 'none';
        window.toggleSidebar = () => document.getElementById('appSidebar').classList.toggle('collapsed');

        window.checkLogin = () => {
            const email = document.getElementById("loginEmail").value;
            const pass = document.getElementById("loginPass").value;
            signInWithEmailAndPassword(auth, email, pass).catch(e => document.getElementById("login-msg").innerText = "ACCESS DENIED");
        };
        window.loginWithGoogle = () => signInWithPopup(auth, new GoogleAuthProvider()).catch(e => console.error(e));
        window.logout = () => signOut(auth).then(() => window.location.reload());

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                try {
                    const adminDocRef = doc(db, "Admin", user.email);
                    const docSnap = await getDoc(adminDocRef); 
                    if (docSnap.exists()) {
                        document.getElementById("login-screen").style.display = "none";
                        document.getElementById("main-interface").style.display = "flex";
                        setTimeout(() => document.getElementById("main-interface").style.opacity = "1", 50);
                        document.getElementById("userName").innerText = (user.displayName || user.email.split('@')[0]).toUpperCase(); 
                        initApp();
                    } else { throw new Error("Doc ID match failed"); }
                } catch (error) {
                    console.warn("Access verification failed:", error);
                    signOut(auth).then(() => { document.getElementById("login-msg").innerText = "UNAUTHORIZED OPERATOR"; document.getElementById("login-screen").style.display = "flex"; });
                }
            } else { document.getElementById("login-screen").style.display = "flex"; document.getElementById("main-interface").style.display = "none"; }
        });

        function initApp() {
            renderKnownSeasons();
            populateDropdowns();
            changeSeason();
            initGlobe(); 
        }

        function populateDropdowns() {
            const ts = document.getElementById("trackSelector");
            ts.innerHTML = '<option value="">-- CHOOSE CIRCUIT --</option>';
            MASTER_TRACK_LIST.forEach(t => ts.innerHTML += `<option value="${t.id}">${t.name.toUpperCase()}</option>`);
            const teamOptions = TEAMS.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
            document.getElementById("newDriverTeam").innerHTML = teamOptions;
            document.getElementById("editorMainTeam").innerHTML = teamOptions;
        }

        window.switchTab = (id) => {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            const target = document.getElementById(id);
            if(target) target.classList.add('active');
            const items = document.querySelectorAll('.nav-btn');
            items.forEach(i => { if(i.getAttribute('onclick').includes(id)) i.classList.add('active'); });
            if(window.innerWidth <= 900) { document.getElementById('appSidebar').classList.remove('collapsed'); }
        };

        window.changeSeason = async () => {
            const inputVal = document.getElementById("seasonInput").value.trim().toLowerCase().replace(/\s+/g, '_');
            if(!inputVal) return;
            currentSeason = inputVal;
            if(!knownSeasons.includes(currentSeason)) {
                knownSeasons.push(currentSeason);
                localStorage.setItem('ttrl_seasons', JSON.stringify(knownSeasons));
                renderKnownSeasons();
            }
            await loadTrackConfig();
            initListener(); 
        };

        function renderKnownSeasons() {
            const c = document.getElementById("knownSeasonsList");
            c.innerHTML = knownSeasons.map(s => `<span style="cursor:pointer; margin-right:10px; opacity:0.6;" onclick="document.getElementById('seasonInput').value='${s}';changeSeason()">${s.toUpperCase()}</span>`).join('| ');
        }

        function updateDashboard() {
            const safeSet = (id, val) => { const el = document.getElementById(id); if(el) el.innerText = val; };
            safeSet('dashDriverCount', allDrivers.length);
            safeSet('dashTrackCount', activeTracks.length);
            
            let mostWins = { name: "--", count: 0 }, totalEntries = 0, totalPointsScored = 0;

            if(allDrivers.length > 0) {
                const leader = allDrivers.reduce((prev, current) => (prev.totalPoints > current.totalPoints) ? prev : current);
                safeSet('dashLeader', leader.name.toUpperCase());
                safeSet('dashLeaderPts', `${leader.totalPoints} PTS`);
                allDrivers.forEach(d => {
                     const results = d.results || {};
                     let dWins = 0;
                     Object.values(results).forEach(r => {
                         const p = (typeof r === 'object') ? r.points : r;
                         if(p > 0) { totalEntries++; totalPointsScored += p; }
                         if(p >= 25) dWins++; 
                     });
                     if(dWins > mostWins.count) mostWins = { name: d.name, count: dWins };
                });
            } else { safeSet('dashLeader', "--"); safeSet('dashLeaderPts', "0 PTS"); }

            const teamPoints = {};
            allDrivers.forEach(d => {
                const results = d.results || {};
                Object.values(results).forEach(r => {
                    const p = (typeof r === 'object') ? r.points : r;
                    const t = (typeof r === 'object') ? r.team : d.team;
                    if(t !== 'reserve') { teamPoints[t] = (teamPoints[t]||0) + p; }
                });
            });
            let topTeam = { id: '--', pts: 0 };
            Object.keys(teamPoints).forEach(tid => { if(teamPoints[tid] > topTeam.pts) topTeam = { id: tid, pts: teamPoints[tid] }; });
            const teamName = TEAMS.find(t => t.id === topTeam.id)?.name || topTeam.id;
            safeSet('dashTeamLeader', teamName.toUpperCase());
            safeSet('dashTeamPts', `${topTeam.pts} PTS`);

            // Calendar Logic
            const now = new Date();
            let nextRace = null;
            let racesDone = 0;
            const calList = document.getElementById('dashCalendarList');
            if (calList) {
                calList.innerHTML = "";
                activeTracks.forEach((t, i) => {
                    let statusColor = "#666", statusIcon = "";
                    if(t.date) {
                        const d = new Date(t.date);
                        if(d < now) { racesDone++; statusColor = "var(--accent-green)"; statusIcon = `<i class="fas fa-check"></i>`; } 
                        else if (!nextRace) { nextRace = t; statusColor = "var(--accent-cyan)"; statusIcon = `<i class="fas fa-flag"></i>`; }
                    }
                    calList.innerHTML += `<div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid rgba(255,255,255,0.05); color:${statusColor}"><span>${String(i+1).padStart(2,'0')} ${t.name}</span><span>${t.date || 'TBD'} ${statusIcon}</span></div>`;
                });
            } else {
                activeTracks.forEach((t) => { if(t.date && new Date(t.date) < now) racesDone++; else if(t.date && !nextRace) nextRace = t; });
            }
            
            const totalRaces = activeTracks.length || 1;
            const pct = Math.round((racesDone / totalRaces) * 100);
            safeSet('dashProgressPct', `${pct}%`);
            safeSet('dashRacesDone', `${racesDone} / ${totalRaces} RACES`);
            const bar = document.getElementById('dashProgressBar');
            if(bar) bar.style.width = `${pct}%`;

            if(nextRace) {
                const parts = nextRace.id.split('_');
                const name = parts.map(p => p.charAt(0).toUpperCase() + p.slice(1)).join(' ');
                safeSet('dashNextRace', name + ' GP');
            } else { safeSet('dashNextRace', "SEASON END"); }

            let lastWinnerName = "--", lastWinnerGP = "NO RACES";
            if (racesDone > 0) {
                const pastRaces = activeTracks.filter(t => t.date && new Date(t.date) < now);
                pastRaces.sort((a,b) => new Date(b.date) - new Date(a.date));
                const lastRace = pastRaces[0];
                if (lastRace) {
                    lastWinnerGP = lastRace.name.toUpperCase();
                    let maxPts = -1, winner = null;
                    allDrivers.forEach(d => {
                        const r = d.results ? d.results[lastRace.id] : null;
                        if (r) {
                            const p = (typeof r === 'object') ? r.points : r;
                            if (p > maxPts) { maxPts = p; winner = d.name; }
                        }
                    });
                    if (winner) lastWinnerName = winner;
                }
            }
            safeSet('dashLastWinner', lastWinnerName.toUpperCase());
            safeSet('dashLastGP', lastWinnerGP);
            updateGlobeMarkers();
        }

        async function loadTrackConfig() {
            const list = document.getElementById("trackConfigList");
            const docRef = doc(db, "seasons", currentSeason);
            try {
                const snap = await getDoc(docRef);
                activeTracks = (snap.exists() && snap.data().trackConfig) ? snap.data().trackConfig : [];
                activeTracks.sort((a, b) => new Date(a.date || '9999-12-31') - new Date(b.date || '9999-12-31'));
            } catch (e) { activeTracks = []; }

            if(activeTracks.length === 0) list.innerHTML = `<div style="text-align:center; color:#666; padding:20px;">NO TRACKS CONFIGURED</div>`;
            else {
                list.innerHTML = activeTracks.map(t => `<div style="background:var(--bg-panel); border:1px solid var(--border-dim); padding:12px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center;"><div style="display:flex; align-items:center; gap:15px;"><input type="checkbox" class="track-checkbox" value="${t.id}" style="transform:scale(1.2);"><span style="font-weight:bold; color:#fff;">${t.name}</span></div><div style="display:flex; gap:10px; align-items:center;"><input type="date" value="${t.date || ''}" onchange="updateTrackDate('${t.id}', this.value)" style="background:#222; border:1px solid #444; color:#fff; padding:4px;"><button class="icon-btn delete" onclick="removeTrackConfig('${t.id}')"><i class="fas fa-times"></i></button></div></div>`).join('');
            }
            
            const rs = document.getElementById("raceDirectorTrackSelect");
            if (rs) {
                rs.innerHTML = '<option value="">-- SELECT EVENT --</option>';
                activeTracks.forEach(t => rs.innerHTML += `<option value="${t.id}">${t.name.toUpperCase()}</option>`);
            }
            updateDashboard();
        }

        window.addTrackConfig = async () => {
            const id = document.getElementById("trackSelector").value;
            const date = document.getElementById("newTrackDate").value;
            if(!id || !date) { showToast("Select Track & Date"); return; }
            if(activeTracks.some(t => t.id === id)) { showToast("Track already exists"); return; }
            const obj = MASTER_TRACK_LIST.find(t => t.id === id);
            const newTrack = { id, name: obj.name, date };
            const ref = doc(db, "seasons", currentSeason);
            const snap = await getDoc(ref);
            if(!snap.exists()) await setDoc(ref, { trackConfig: [newTrack] });
            else await updateDoc(ref, { trackConfig: arrayUnion(newTrack) });
            loadTrackConfig(); showToast("Track Added");
        };

        window.updateTrackDate = async (trackId, newDate) => {
            const ref = doc(db, "seasons", currentSeason);
            const snap = await getDoc(ref);
            if(snap.exists()) {
                let tracks = snap.data().trackConfig || [];
                const idx = tracks.findIndex(t => t.id === trackId);
                if(idx !== -1) { tracks[idx].date = newDate; await updateDoc(ref, { trackConfig: tracks }); showToast("Date Updated"); updateDashboard(); }
            }
        };

        window.removeTrackConfig = (id) => {
            customConfirm("Remove this track?", async () => {
                const ref = doc(db, "seasons", currentSeason);
                const snap = await getDoc(ref);
                if(snap.exists()) {
                    const tracks = snap.data().trackConfig.filter(t => t.id !== id);
                    await updateDoc(ref, { trackConfig: tracks });
                    loadTrackConfig(); showToast("Track Removed");
                }
            });
        };

        window.toggleTrackSelectAll = () => {
            const cbs = document.querySelectorAll('.track-checkbox');
            const all = Array.from(cbs).every(c => c.checked);
            cbs.forEach(c => c.checked = !all);
        };

        window.deleteSelectedTracks = () => {
            const cbs = document.querySelectorAll('.track-checkbox:checked');
            if(cbs.length === 0) return;
            customConfirm(`Delete ${cbs.length} tracks?`, async () => {
                const idsToRemove = Array.from(cbs).map(c => c.value);
                const ref = doc(db, "seasons", currentSeason);
                const snap = await getDoc(ref);
                if(snap.exists()) {
                    const currentTracks = snap.data().trackConfig || [];
                    const newTracks = currentTracks.filter(t => !idsToRemove.includes(t.id));
                    await updateDoc(ref, { trackConfig: newTracks });
                    loadTrackConfig(); showToast("Tracks Deleted");
                }
            });
        };

        // --- DRIVER DATA & OTHER FUNCTIONS (Standard) ---
        function initListener() {
            if(unsubscribe) unsubscribe();
            const q = query(collection(db, "seasons", currentSeason, "drivers"), orderBy("totalPoints", "desc"));
            unsubscribe = onSnapshot(q, (snap) => {
                const list = document.getElementById("driverList");
                const statSel = document.getElementById("statsDriverSelect");
                const grid = document.getElementById("editorSelectionGrid");
                list.innerHTML = ""; statSel.innerHTML = '<option value="">-- SELECT DRIVER --</option>'; grid.innerHTML = ""; allDrivers = [];
                if(snap.empty) { list.innerHTML = `<div style="padding:20px; color:#666;">GRID EMPTY</div>`; grid.innerHTML = `<div style="padding:20px; color:#666;">NO DRIVERS FOUND</div>`; }
                snap.forEach(d => {
                    const data = d.data(); data.id = d.id; driversCache[d.id] = data; allDrivers.push(data);
                    const teamColor = TEAM_COLORS[data.team] || '#444';
                    statSel.innerHTML += `<option value="${d.id}">${data.name.toUpperCase()}</option>`;
                    list.innerHTML += `<div class="driver-card" style="--team-color:${teamColor}"><div style="display:flex; align-items:center; gap:10px;"><input type="checkbox" class="driver-checkbox" value="${d.id}" style="transform:scale(1.2);"><div class="driver-info"><h4>${data.name}</h4><p style="color:var(--text-secondary);">${data.team}</p></div></div><button class="icon-btn delete" onclick="deleteDriver('${d.id}')"><i class="fas fa-trash"></i></button></div>`;
                    grid.innerHTML += `<div class="driver-card" style="--team-color:${teamColor}; cursor:pointer;" onclick="loadDriverData('${d.id}')"><div class="driver-info"><h4>${data.name}</h4><p>${data.team}</p></div><div style="font-family:var(--font-display); font-size:1.2rem; color:var(--accent-cyan);">${data.totalPoints} PTS</div></div>`;
                });
                updateLiveTables(); updateDashboard();
                if(document.getElementById("raceDirectorGrid").style.display === "block") loadRaceGrid();
                const currentEditId = document.getElementById("editorDriverIdHidden").value;
                if(document.getElementById("editor-area").style.display === "block" && currentEditId && driversCache[currentEditId]) loadDriverData(currentEditId);
                if(document.getElementById("statsDisplay").style.display === "block") viewDriverStats();
            });
        }

        window.registerDriver = async () => {
            const name = document.getElementById("newDriverName").value;
            const team = document.getElementById("newDriverTeam").value;
            if(!name) return;
            try { await addDoc(collection(db, "seasons", currentSeason, "drivers"), { name, team, totalPoints: 0, results: {} }); document.getElementById("newDriverName").value = ""; showToast("Driver Added"); } catch(e) { console.error(e); }
        };

        window.deleteDriver = (id) => {
            const d = driversCache[id];
            customConfirm(`Delete ${d ? d.name : 'driver'}?`, async () => { await deleteDoc(doc(db, "seasons", currentSeason, "drivers", id)); showToast("Deleted"); });
        };

        window.toggleSelectAll = () => { const cbs = document.querySelectorAll('.driver-checkbox'); const all = Array.from(cbs).every(c => c.checked); cbs.forEach(c => c.checked = !all); };
        window.deleteSelectedDrivers = () => {
            const cbs = document.querySelectorAll('.driver-checkbox:checked');
            if(cbs.length === 0) return;
            customConfirm(`Delete ${cbs.length} drivers?`, async () => {
                const batch = writeBatch(db);
                cbs.forEach(c => batch.delete(doc(db, "seasons", currentSeason, "drivers", c.value)));
                await batch.commit(); showToast("Batch Delete Complete");
            });
        };

        window.exportData = () => {
            const exportObj = { season: currentSeason, tracks: activeTracks, drivers: allDrivers };
            const blob = new Blob([JSON.stringify(exportObj, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `TTRL_${currentSeason}_backup.json`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); showToast("Export Started");
        };

        // --- MIGRATION & EDITOR (Standard) ---
        window.openMigrationModal = () => { document.getElementById('migrationModal').style.display = 'flex'; document.getElementById('migrationStatus').innerText = ''; };
        window.performMigration = async () => {
            const source = document.getElementById('migrateSource').value.trim();
            const target = document.getElementById('migrateTarget').value.trim();
            const deleteSource = document.getElementById('migrateDelete').checked;
            const status = document.getElementById('migrationStatus');
            if(!source || !target || source === target) { status.innerText = "Error: Invalid Season IDs"; return; }
            status.innerText = "Migrating...";
            try {
                const sourceRef = doc(db, 'seasons', source);
                const sourceSnap = await getDoc(sourceRef);
                const tracks = sourceSnap.exists() ? (sourceSnap.data().trackConfig || []) : [];
                const driversRef = collection(db, 'seasons', source, 'drivers');
                const driversSnap = await getDocs(driversRef);
                const targetRef = doc(db, 'seasons', target);
                await setDoc(targetRef, { trackConfig: tracks }, { merge: true });
                const batch = writeBatch(db);
                driversSnap.forEach(d => { const newDocRef = doc(db, 'seasons', target, 'drivers', d.id); batch.set(newDocRef, d.data()); });
                await batch.commit();
                if(deleteSource) { const delBatch = writeBatch(db); driversSnap.forEach(d => delBatch.delete(d.ref)); delBatch.delete(sourceRef); await delBatch.commit(); }
                status.innerText = "SUCCESS!";
                setTimeout(() => { document.getElementById('migrationModal').style.display = 'none'; if(document.getElementById('seasonInput').value === target) changeSeason(); }, 1500);
            } catch(e) { status.innerText = "Failed: " + e.message; }
        };

        window.loadDriverData = (id) => {
            if(!id) return;
            document.getElementById("editorSelectionGrid").style.display = "none"; document.getElementById("editor-area").style.display = "block";
            const data = driversCache[id];
            document.getElementById("editorDriverNameDisplay").innerText = data.name.toUpperCase();
            document.getElementById("editorMainTeam").value = data.team;
            document.getElementById("editorDriverIdHidden").value = id;
            const grid = document.getElementById("trackGrid"); grid.innerHTML = "";
            if(activeTracks.length === 0) { grid.innerHTML = "No Tracks Configured"; return; }
            const res = data.results || {};
            let teamOpts = `<optgroup label="Teams">` + TEAMS.map(tm => `<option value="${tm.id}">${tm.name}</option>`).join('') + `</optgroup>`;
            activeTracks.forEach(t => {
                let pts = 0, raceTeam = data.team, pos = ""; 
                if(res[t.id]) { 
                    if(typeof res[t.id] === 'object') { 
                        pts = res[t.id].points || 0; 
                        raceTeam = res[t.id].team || data.team; 
                        pos = res[t.id].position || "";
                    } else { pts = res[t.id]; } 
                }
                grid.innerHTML += `<div style="background:var(--bg-panel); border:1px solid var(--border-dim); padding:15px; border-radius:6px;">
                    <label class="input-label">${t.name}</label>
                    <div style="display:flex; gap:10px;">
                        <input type="text" class="pos-in form-control" style="width:60px; text-align:center;" placeholder="POS" value="${pos}">
                        <input type="number" class="pts-in form-control" style="width:80px; text-align:center; font-weight:bold; color:var(--accent-cyan);" data-track="${t.id}" value="${pts}" oninput="calcTotal()">
                        <select class="tm-in form-control" id="tm-${t.id}">${teamOpts}</select>
                    </div>
                </div>`;
                document.getElementById(`tm-${t.id}`).value = raceTeam;
            });
            calcTotal();
        };
        window.closeDriverEditor = () => { document.getElementById("editor-area").style.display = "none"; document.getElementById("editorSelectionGrid").style.display = "grid"; document.getElementById("editorDriverIdHidden").value = ""; };
        window.updateMainTeam = async () => { const id = document.getElementById("editorDriverIdHidden").value; if(!id) return; const team = document.getElementById("editorMainTeam").value; await updateDoc(doc(db, "seasons", currentSeason, "drivers", id), { team }); showToast("Main Contract Updated"); };
        window.calcTotal = () => { let s = 0; document.querySelectorAll(".pts-in").forEach(i => s += Number(i.value)||0); document.getElementById("calculatedTotal").innerText = s; };
        window.saveAllChanges = async () => {
            const id = document.getElementById("editorDriverIdHidden").value; if(!id) return;
            const ptsIns = document.querySelectorAll(".pts-in"); 
            const tmIns = document.querySelectorAll(".tm-in");
            const posIns = document.querySelectorAll(".pos-in");
            let newResults = {}, total = 0;
            ptsIns.forEach((p, idx) => { 
                const val = Number(p.value); 
                const posVal = posIns[idx].value.trim();
                // Save entry if points > 0 OR if a position is entered (e.g. DNF with 0 points)
                if(val > 0 || posVal !== "") { 
                    newResults[p.dataset.track] = { points: val, position: posVal, team: tmIns[idx].value }; 
                    total += val; 
                } 
            });
            await updateDoc(doc(db, "seasons", currentSeason, "drivers", id), { results: newResults, totalPoints: total }); showToast("Driver Updated");
        };

        window.triggerImport = () => document.getElementById('csvFile').click();
        window.handleFileSelect = (input) => { if(input.files[0]) { const r = new FileReader(); r.onload = (e) => parseCSV(e.target.result); r.readAsText(input.files[0]); } };
        function parseCSV(text) {
            const lines = text.split('\n'); pendingImportData = []; pendingImportTracks.clear();
            const headers = lines[0].split(',').map(s => s.trim().replace(/^"|"$/g,''));
            const colMap = {};
            headers.forEach((h, i) => { const mid = MASTER_TRACK_LIST.find(t => h.toLowerCase().includes(t.id.split('_')[0]))?.id; if(mid) { colMap[i] = mid; pendingImportTracks.add(mid); } });
            lines.slice(1).forEach(line => {
                if(!line.trim()) return; const p = line.split(',').map(s => s.trim().replace(/^"|"$/g,'')); if(p.length < 2) return;
                const name = p[0]; const teamRaw = p[1].toLowerCase().replace(/\s/g,'-');
                const tObj = TEAMS.find(t => t.id === teamRaw || t.name.toLowerCase() === p[1].toLowerCase());
                const teamId = tObj ? tObj.id : 'reserve';
                let res = {}, tot = 0;
                Object.keys(colMap).forEach(idx => { const pts = parseInt(p[idx]); if(!isNaN(pts) && pts > 0) { res[colMap[idx]] = { points: pts, team: teamId }; tot += pts; } });
                pendingImportData.push({ name, team: teamId, results: res, totalPoints: tot });
            });
            switchTab('import-preview'); document.getElementById('import-preview').classList.add('active'); document.getElementById('detectedTracksList').innerText = Array.from(pendingImportTracks).join(', ').toUpperCase() || "NONE";
            const tb = document.getElementById('importTableBody'); tb.innerHTML = "";
            pendingImportData.forEach((d, i) => { const tOpts = TEAMS.map(t => `<option value="${t.id}" ${t.id===d.team?'selected':''}>${t.name}</option>`).join(''); tb.innerHTML += `<tr><td><input value="${d.name}" class="form-control" onchange="pendingImportData[${i}].name=this.value"></td><td><select class="form-control" onchange="pendingImportData[${i}].team=this.value; updateImpTeam(${i}, this.value)">${tOpts}</select></td><td style="color:var(--accent-cyan); font-weight:bold;">${d.totalPoints}</td><td style="color:var(--accent-green)">READY</td></tr>`; });
        }
        window.updateImpTeam = (idx, nt) => { const r = pendingImportData[idx].results; Object.keys(r).forEach(k => r[k].team = nt); };
        window.cancelImport = () => { document.getElementById('csvFile').value = ""; switchTab('manage-drivers'); };
        window.commitImport = async () => {
            const sRef = doc(db, "seasons", currentSeason); const snap = await getDoc(sRef);
            let tracks = (snap.exists() && snap.data().trackConfig) ? snap.data().trackConfig : [];
            const newT = []; pendingImportTracks.forEach(tid => { if(!tracks.some(t => t.id === tid)) { const m = MASTER_TRACK_LIST.find(x => x.id === tid); newT.push({ id: tid, name: m ? m.name : tid.toUpperCase(), date: "" }); } });
            if(newT.length > 0) { if(snap.exists()) await updateDoc(sRef, { trackConfig: arrayUnion(...newT) }); else await setDoc(sRef, { trackConfig: newT }); }
            const batch = writeBatch(db); pendingImportData.forEach(d => { if(d.name) { batch.set(doc(collection(db, "seasons", currentSeason, "drivers")), { name: d.name, team: d.team, totalPoints: d.totalPoints, results: d.results }); } });
            await batch.commit(); loadTrackConfig(); cancelImport(); showToast(`Imported ${pendingImportData.length} Drivers`);
        };

        // --- VISUALIZATION HELPERS ---
        function updateLiveTables() {
            const tD = document.getElementById("liveDriversBody"); tD.innerHTML = "";
            const sorted = [...allDrivers].sort((a,b) => { if(a.team==='reserve' && b.team!=='reserve') return 1; if(a.team!=='reserve' && b.team==='reserve') return -1; return b.totalPoints - a.totalPoints; });
            sorted.forEach((d,i) => { tD.innerHTML += `<tr><td style="color:#666;">${i+1}</td><td><div style="font-weight:bold; color:#fff;">${d.name}</div><div style="font-size:0.7rem; color:var(--accent-cyan);">${d.team.toUpperCase()}</div></td><td style="text-align:right; font-weight:bold; font-size:1.1rem; color:var(--accent-cyan);">${d.totalPoints}</td></tr>`; });
            const teamPts = {}; allDrivers.forEach(d => { const res = d.results || {}; Object.values(res).forEach(r => { const p = (typeof r === 'object') ? r.points : r; const t = (typeof r === 'object') ? r.team : d.team; if(t !== 'reserve') { teamPts[t] = (teamPts[t]||0) + p; } }); });
            const tC = document.getElementById("liveConstructorsBody"); tC.innerHTML = "";
            Object.keys(teamPts).map(k => ({id:k, p:teamPts[k]})).sort((a,b) => b.p - a.p).forEach((x,i) => { const tn = TEAMS.find(t=>t.id===x.id)?.name || x.id; tC.innerHTML += `<tr><td style="color:#666;">${i+1}</td><td style="font-weight:bold; color:#fff; text-transform:uppercase;">${tn}</td><td style="text-align:right; font-weight:bold; color:var(--accent-red);">${x.p}</td></tr>`; });
        }

        window.loadRaceGrid = () => {
            const tid = document.getElementById("raceDirectorTrackSelect").value; const con = document.getElementById("raceInputsContainer"); const wrap = document.getElementById("raceDirectorGrid"); if(!tid) { wrap.style.display="none"; return; } wrap.style.display="block"; con.innerHTML = "";
            [...allDrivers].sort((a,b)=>a.name.localeCompare(b.name)).forEach(d => {
                const r = d.results || {}; 
                const pts = (r[tid] && typeof r[tid]==='object') ? r[tid].points : (r[tid] || 0); 
                const pos = (r[tid] && typeof r[tid]==='object') ? r[tid].position : "";
                const team = (r[tid] && typeof r[tid]==='object') ? r[tid].team : d.team; 
                const teamColor = TEAM_COLORS[team] || '#555'; 
                const hasPoints = pts > 0 ? 'border-color:var(--accent-cyan); box-shadow:0 0 10px rgba(0,240,255,0.2);' : '';
                con.innerHTML += `
                    <div class="driver-card" style="--team-color:${teamColor}; ${hasPoints}">
                        <div style="display:flex; flex-direction:column;">
                            <span style="font-weight:bold;">${d.name}</span>
                            <span style="font-size:0.75rem; color:#888;">${team.toUpperCase()}</span>
                        </div>
                        <div style="display:flex; gap:5px;">
                            <input type="text" class="rc-pos-input form-control" style="width:50px; text-align:center; padding:5px; font-size:0.8rem;" placeholder="POS" value="${pos || ''}">
                            <input type="number" class="rc-points-input form-control" style="width:60px; text-align:center; padding:5px; font-weight:bold;" placeholder="PTS" data-did="${d.id}" value="${pts}">
                        </div>
                    </div>`;
            });
        };

        window.saveRaceResults = async () => {
            const tid = document.getElementById("raceDirectorTrackSelect").value; if(!tid) return; 
            const ptsInps = document.querySelectorAll(".rc-points-input"); 
            const posInps = document.querySelectorAll(".rc-pos-input");
            const batch = writeBatch(db); let changes = 0;
            
            ptsInps.forEach((inp, idx) => { 
                const did = inp.dataset.did; 
                const newP = Number(inp.value); 
                const newPos = posInps[idx].value.trim();
                const d = driversCache[did]; 
                const oldRes = d.results || {}; 
                const oldP = (oldRes[tid] && typeof oldRes[tid]==='object') ? oldRes[tid].points : (oldRes[tid]||0);
                const oldPos = (oldRes[tid] && typeof oldRes[tid]==='object') ? oldRes[tid].position : "";
                
                if(oldP !== newP || oldPos !== newPos) { 
                    const newTot = d.totalPoints - oldP + newP; 
                    const resUpd = { ...oldRes }; 
                    let tRace = d.team; 
                    if(oldRes[tid] && oldRes[tid].team) tRace = oldRes[tid].team; 
                    
                    if(newP > 0 || newPos !== "") {
                        resUpd[tid] = { points: newP, position: newPos, team: tRace }; 
                    } else delete resUpd[tid]; 
                    
                    batch.update(doc(db, "seasons", currentSeason, "drivers", did), { results: resUpd, totalPoints: newTot }); 
                    changes++; 
                }
            });
            if(changes > 0) { await batch.commit(); showToast("Results Saved"); } else showToast("No Changes");
        };

        window.viewDriverStats = () => {
            const id = document.getElementById("statsDriverSelect").value; const disp = document.getElementById("statsDisplay"); if(!id) { disp.style.display="none"; return; } disp.style.display="block";
            const d = driversCache[id]; document.getElementById("statsDriverName").innerText = d.name.toUpperCase(); document.getElementById("statsTeamName").innerText = TEAMS.find(t=>t.id===d.team)?.name.toUpperCase() || d.team; document.getElementById("statPoints").innerHTML = `${d.totalPoints} <span style="font-size:1rem; color:#888;">PTS</span>`;
            
            let w=0, p=0, r=0, entries=0, best=0, dnf=0, hHTML=""; 
            const labels = [], dataPoints = [], barData = []; let cumulative = 0;
            let totalPos = 0, finishedRaces = 0;

            activeTracks.forEach(t => { 
                const res = d.results ? d.results[t.id] : null; 
                const pt = (res && typeof res === 'object') ? res.points : (res || 0); 
                const pos = (res && typeof res === 'object') ? res.position : "-";
                
                if(res) { 
                    entries++; 
                    // Calculate stats
                    if(pt > 0) { 
                        r++; cumulative += pt; 
                        if(pt > best) best = pt; 
                        if(pt>=25) w++; 
                        if(pt>=15) p++; 
                    }
                    
                    // Track finishes for Avg
                    const numPos = parseInt(pos);
                    if(!isNaN(numPos)) {
                        totalPos += numPos;
                        finishedRaces++;
                    }

                    const tm = (typeof res === 'object') ? res.team : d.team; 
                    const tName = TEAMS.find(x=>x.id===tm)?.name || tm; 
                    hHTML += `<tr><td>${t.name.toUpperCase()}</td><td style="color:var(--accent-yellow); font-weight:bold;">${pos}</td><td style="color:#888;">${tName}</td><td style="text-align:right; font-weight:bold; color:var(--accent-cyan);">${pt}</td></tr>`; 
                    
                    labels.push(t.id.substring(0,3).toUpperCase()); 
                    dataPoints.push(cumulative); 
                    barData.push(pt); 
                } 
            });
            
            let avg = finishedRaces > 0 ? totalPos / finishedRaces : 0; 
            let variance = 0; // Consistency based on points variance for now
            if(r > 0) { barData.forEach(pt => { if(pt>0) variance += Math.pow(pt - (d.totalPoints/r), 2); }); variance = Math.sqrt(variance / r).toFixed(1); }
            
            document.getElementById("statWins").innerText = w; 
            document.getElementById("statPodiums").innerText = p; 
            document.getElementById("statAvg").innerText = avg > 0 ? "P" + avg.toFixed(1) : "-"; 
            document.getElementById("statConsistency").innerText = variance; 
            document.getElementById("statsHistoryBody").innerHTML = hHTML || `<tr><td colspan="4" style="text-align:center;">NO DATA</td></tr>`;
            
            renderChart(labels, dataPoints, barData);
        };

        function renderChart(labels, lineData, barData) {
            const ctx1 = document.getElementById('pointsChart'); if(statsChart) statsChart.destroy(); statsChart = new Chart(ctx1, { type: 'line', data: { labels: labels, datasets: [{ label: 'Points', data: lineData, borderColor: '#00f0ff', backgroundColor: 'rgba(0, 240, 255, 0.1)', tension: 0.3, fill: true, pointBackgroundColor: '#fff' }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' } }, x: { grid: { display: false } } }, plugins: { legend: { display: false } } } });
            const ctx2 = document.getElementById('barChart'); if(barChart) barChart.destroy(); barChart = new Chart(ctx2, { type: 'bar', data: { labels: labels, datasets: [{ label: 'Points', data: barData, backgroundColor: 'rgba(255, 59, 59, 0.6)', borderColor: '#ff3b3b', borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' } }, x: { grid: { display: false } } }, plugins: { legend: { display: false } } } });
        }

        // --- THREE.JS GLOBE INIT ---
        function initGlobe() {
            if(!globeContainer) return;
            const w = globeContainer.offsetWidth;
            const h = globeContainer.offsetHeight;

            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(45, w / h, 0.1, 1000);
            camera.position.z = 250;
            camera.position.y = 100;

            renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
            renderer.setSize(w, h);
            globeContainer.innerHTML = '';
            globeContainer.appendChild(renderer.domElement);

            const loader = new THREE.TextureLoader();
            loader.load('https://ksenia-k.com/img/earth-map-colored.png', (texture) => {
                const material = new THREE.ShaderMaterial({
                    uniforms: { u_map_tex: { type: 't', value: texture }, u_dot_size: { type: 'f', value: 4.5 }, u_time_since_click: { value: 0 }, u_pointer: { value: new THREE.Vector3() } },
                    vertexShader: document.getElementById("vertex-shader-map").textContent,
                    fragmentShader: document.getElementById("fragment-shader-map").textContent,
                    transparent: true
                });
                const sphereGeo = new THREE.SphereGeometry(80, 64, 64);
                globe = new THREE.Points(sphereGeo, material);
                globe.rotation.y = -Math.PI / 2;
                scene.add(globe);

                const innerGeo = new THREE.SphereGeometry(79.5, 32, 32);
                const innerMat = new THREE.MeshBasicMaterial({ color: 0x000000 });
                const innerMesh = new THREE.Mesh(innerGeo, innerMat);
                scene.add(innerMesh);
                updateGlobeMarkers();
            });

            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableZoom = true; controls.enablePan = false; controls.minDistance = 120; controls.maxDistance = 400; controls.autoRotate = true; controls.autoRotateSpeed = 0.5;

            const raycaster = new THREE.Raycaster();
            const mouse = new THREE.Vector2();
            const tooltip = document.getElementById('globe-tooltip');
            const ttTitle = document.getElementById('gt-title');
            const ttStatus = document.getElementById('gt-status');
            const ttCoords = document.getElementById('gt-coords');

            window.addEventListener('resize', () => { if(!globeContainer) return; const nw = globeContainer.offsetWidth; const nh = globeContainer.offsetHeight; renderer.setSize(nw, nh); camera.aspect = nw / nh; camera.updateProjectionMatrix(); });

            renderer.domElement.addEventListener('mousemove', (e) => {
                const rect = renderer.domElement.getBoundingClientRect();
                mouse.x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
                mouse.y = -((e.clientY - rect.top) / rect.height) * 2 + 1;
                raycaster.setFromCamera(mouse, camera);
                const intersects = raycaster.intersectObjects(globeMarkers);
                
                if (intersects.length > 0) {
                    controls.autoRotate = false;
                    document.body.style.cursor = 'pointer';
                    const marker = intersects[0].object;
                    const data = marker.userData;
                    
                    tooltip.style.display = 'block';
                    // Calculate position relative to container
                    tooltip.style.left = (e.clientX - rect.left + 20) + 'px';
                    tooltip.style.top = (e.clientY - rect.top + 20) + 'px';
                    
                    ttTitle.innerText = data.name;
                    ttStatus.innerText = data.date ? `SCHEDULED: ${data.date}` : "DATE TBD";
                    ttCoords.innerText = `LAT: ${data.coords?.lat.toFixed(2) || '0.00'} | LON: ${data.coords?.lon.toFixed(2) || '0.00'}`;

                    marker.scale.set(2, 2, 2);
                    marker.material.opacity = 1;
                    marker.material.color.setHex(0x00ff9d); // Green on hover
                } else {
                    controls.autoRotate = true;
                    document.body.style.cursor = 'default';
                    tooltip.style.display = 'none';
                    globeMarkers.forEach(m => { m.scale.set(1, 1, 1); m.material.opacity = 0.8; m.material.color.setHex(0xff3b3b); });
                }
            });
            animateGlobe();
        }

        function animateGlobe() { requestAnimationFrame(animateGlobe); controls.update(); renderer.render(scene, camera); }
        function latLonToVector3(lat, lon, radius) { const phi = (90 - lat) * (Math.PI / 180); const theta = (lon + 180) * (Math.PI / 180); const x = -(radius * Math.sin(phi) * Math.cos(theta)); const z = (radius * Math.sin(phi) * Math.sin(theta)); const y = (radius * Math.cos(phi)); return new THREE.Vector3(x, y, z); }
        
        function updateGlobeMarkers() {
            if(!globe) return;
            globeMarkers.forEach(m => scene.remove(m)); globeMarkers = [];
            activeTracks.forEach(t => {
                const coords = TRACK_COORDS[t.id];
                if(coords) {
                    const pos = latLonToVector3(coords.lat, coords.lon, 80);
                    const geom = new THREE.SphereGeometry(1.5, 8, 8);
                    const mat = new THREE.MeshBasicMaterial({ color: 0xff3b3b, transparent: true, opacity: 0.8 });
                    const mesh = new THREE.Mesh(geom, mat);
                    pos.applyAxisAngle(new THREE.Vector3(0, 1, 0), -Math.PI / 2);
                    mesh.position.copy(pos);
                    mesh.userData = { name: t.name, date: t.date, coords: coords };
                    scene.add(mesh); globeMarkers.push(mesh);
                }
            });
        }
    </script>
</body>
</html>
