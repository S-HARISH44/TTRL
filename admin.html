<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TTRL Pitwall</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --bg: #0b0c10; --card: #1f2833; --accent: #66fcf1; --text: #c5c6c7; --red: #ff1f4b; }
        body { background: var(--bg); color: var(--text); font-family: 'Rajdhani', sans-serif; margin: 0; padding: 20px; }
        
        /* LOGIN */
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 999; display: flex; justify-content: center; align-items: center; transition: opacity 0.5s; }
        .login-box { background: var(--card); padding: 2rem; border-radius: 8px; text-align: center; border: 1px solid #333; width: 300px; box-shadow: 0 0 30px rgba(102, 252, 241, 0.1); }
        
        /* LAYOUT */
        .container { max-width: 1100px; margin: 0 auto; display: none; }
        header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--accent); padding-bottom: 10px; margin-bottom: 20px; }
        h1 { margin: 0; color: var(--accent); text-transform: uppercase; }
        
        /* TABS */
        .nav-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { flex: 1; padding: 15px; background: var(--card); border: none; color: #fff; cursor: pointer; font-family: 'Rajdhani', sans-serif; font-size: 1.2rem; font-weight: bold; text-transform: uppercase; transition: 0.3s; clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px); }
        .tab-btn:hover { background: #2c3e50; }
        .tab-btn.active { background: var(--accent); color: #000; }

        .section { display: none; background: var(--card); padding: 20px; border-radius: 8px; }
        .section.active { display: block; }
        
        /* FORMS & GRID */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; color: #888; font-size: 0.9rem; }
        input, select { width: 100%; padding: 12px; background: #0b0c10; border: 1px solid #45a29e; color: #fff; font-family: inherit; font-size: 1rem; box-sizing: border-box; }
        input:focus, select:focus { outline: none; border-color: var(--accent); }

        .track-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 15px; margin-top: 20px; }
        .track-input { background: rgba(0,0,0,0.3); padding: 15px; border-radius: 5px; border: 1px solid #333; display: flex; flex-direction: column; gap: 8px; }
        .track-input label { color: var(--accent); font-weight: bold; text-transform: uppercase; font-size: 0.9rem; }
        
        .row-inputs { display: flex; gap: 5px; }
        .points-input { flex: 1; text-align: center; font-weight: bold; }
        .team-input { flex: 2; font-size: 0.85rem; color: #aaa; }

        /* TOTALS */
        .total-box { margin-top: 20px; padding: 15px; background: #000; border-left: 4px solid var(--accent); display: flex; justify-content: space-between; align-items: center; }
        .total-value { font-size: 2rem; font-weight: bold; color: #fff; }

        button.action-btn { width: 100%; padding: 15px; background: var(--accent); color: #0b0c10; border: none; font-weight: 800; font-size: 1.1rem; cursor: pointer; text-transform: uppercase; margin-top: 20px; }
        button.action-btn:hover { background: #fff; }
        button.delete-btn { background: var(--red); color: white; border: none; padding: 5px 10px; cursor: pointer; font-size: 0.8rem; }

        /* LIVE TABLES */
        .view-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        .view-table th { text-align: left; padding: 8px; background: rgba(255,255,255,0.1); color: var(--accent); }
        .view-table td { padding: 8px; border-bottom: 1px solid #333; }
        .driver-item { display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.3); padding: 10px; margin-bottom: 5px; border-left: 3px solid #555; }
    </style>
</head>
<body>

    <!-- LOGIN -->
    <div id="login-overlay">
        <div class="login-box">
            <h2>PITWALL ACCESS</h2>
            <input type="password" id="adminPass" placeholder="Enter Password" style="margin-bottom:10px; width:100%;">
            <button class="action-btn" style="margin-top:0;" onclick="checkLogin()">UNLOCK</button>
            <div id="login-msg" style="color:red; margin-top:10px;"></div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div class="container" id="main-interface">
        <header>
            <h1>TTRL Admin</h1>
        </header>

        <div class="nav-tabs">
            <button class="tab-btn active" onclick="switchTab('race-control')">Results Editor</button>
            <button class="tab-btn" onclick="switchTab('live-view')">Live Standings</button>
            <button class="tab-btn" onclick="switchTab('manage-drivers')">Manage Drivers</button>
        </div>

        <!-- 1. EDITOR -->
        <div id="race-control" class="section active">
            <h3><i class="fas fa-edit"></i> Edit Race Results</h3>
            <p style="color:#888;">Select a driver. If they are a Reserve, confirm the team they drove for in the dropdown for that race.</p>
            
            <div class="form-group">
                <select id="editorDriverSelect" onchange="loadDriverData()">
                    <option value="">-- Select Driver --</option>
                </select>
            </div>

            <div id="editor-area" style="display:none;">
                <div class="track-grid" id="trackGrid"></div>

                <div class="total-box">
                    <div style="color:#888; text-transform:uppercase;">Calculated Driver Total</div>
                    <div class="total-value" id="calculatedTotal">0</div>
                </div>

                <button class="action-btn" onclick="saveAllChanges()">SAVE CHANGES</button>
                <div id="editor-status" style="text-align:center; margin-top:10px; font-weight:bold;"></div>
            </div>
        </div>

        <!-- 2. LIVE VIEW -->
        <div id="live-view" class="section">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                <div>
                    <h4 style="color:var(--accent);">Drivers Championship</h4>
                    <table class="view-table">
                        <thead><tr><th style="width:10%">Pos</th><th>Driver & Team</th><th style="text-align:right">Pts</th></tr></thead>
                        <tbody id="liveDriversBody"></tbody>
                    </table>
                </div>
                <div>
                    <h4 style="color:var(--accent);">Constructors Championship</h4>
                    <table class="view-table">
                        <thead><tr><th style="width:10%">Pos</th><th>Team</th><th style="text-align:right">Pts</th></tr></thead>
                        <tbody id="liveConstructorsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 3. MANAGE -->
        <div id="manage-drivers" class="section">
            <h3>Register New Driver</h3>
            <div class="form-group">
                <label>Name</label>
                <input type="text" id="newDriverName" placeholder="Driver Name">
            </div>
            <div class="form-group">
                <label>Default Team</label>
                <select id="newDriverTeam">
                    <option value="red-bull-racing">Red Bull Racing</option>
                    <option value="ferrari">Ferrari</option>
                    <option value="mercedes">Mercedes</option>
                    <option value="mclaren">McLaren</option>
                    <option value="aston-martin">Aston Martin</option>
                    <option value="alpine">Alpine</option>
                    <option value="williams">Williams</option>
                    <option value="racing-bulls">Racing Bulls</option>
                    <option value="kick-sauber">Kick Sauber</option>
                    <option value="haas">Haas</option>
                    <option value="reserve">Reserve / Free Agent</option>
                </select>
            </div>
            <button class="action-btn" onclick="registerDriver()">Add Driver</button>
            <div id="register-status" style="text-align:center; margin-top:10px;"></div>
            <hr style="border-color:#333; margin:20px 0;">
            <h3>Database</h3>
            <div id="driverList">Loading...</div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyApUD33ao9DfFa8IAfA2qby3IFKhLtcNFU",
            authDomain: "ttrl-9f3ef.firebaseapp.com",
            projectId: "ttrl-9f3ef",
            storageBucket: "ttrl-9f3ef.firebasestorage.app",
            messagingSenderId: "51144639440",
            appId: "1:51144639440:web:8a027b773bc2cddefe2fd5"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const colRef = collection(db, "standings");

        // CONSTANTS
        const TRACKS = [
            {id:'bahrain', name:'Bahrain'}, {id:'australia', name:'Australia'}, {id:'imola', name:'Imola'},
            {id:'spain', name:'Spain'}, {id:'uk', name:'Great Britain'}, {id:'vegas', name:'Las Vegas'},
            {id:'belgium', name:'Belgium'}, {id:'austria', name:'Austria'}, {id:'brazil', name:'Brazil'},
            {id:'abu_dhabi', name:'Abu Dhabi'}
        ];

        const TEAMS = [
            {id:'red-bull-racing', name:'Red Bull'}, {id:'ferrari', name:'Ferrari'}, {id:'mercedes', name:'Mercedes'},
            {id:'mclaren', name:'McLaren'}, {id:'aston-martin', name:'Aston Martin'}, {id:'alpine', name:'Alpine'},
            {id:'williams', name:'Williams'}, {id:'racing-bulls', name:'Racing Bulls'}, {id:'kick-sauber', name:'Kick Sauber'},
            {id:'haas', name:'Haas'}, {id:'reserve', name:'Reserve'}
        ];

        let driversCache = {};
        let allDrivers = [];

        // AUTH
        window.checkLogin = () => {
            if(document.getElementById("adminPass").value === "admin123") {
                document.getElementById("login-overlay").style.display = "none";
                document.getElementById("main-interface").style.display = "block";
                initListener();
            } else {
                document.getElementById("login-msg").innerText = "Wrong Password";
            }
        };

        // UI TABS
        window.switchTab = (id) => {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            event.target.classList.add('active');
        };

        // DATABASE LISTENER
        function initListener() {
            onSnapshot(query(colRef, orderBy("totalPoints", "desc")), (snap) => {
                const select = document.getElementById("editorDriverSelect");
                const list = document.getElementById("driverList");
                
                // Clear list but keep dropdown placeholder
                if(select.options.length <= 1) select.innerHTML = '<option value="">-- Select Driver --</option>';
                list.innerHTML = "";
                allDrivers = [];

                snap.forEach(doc => {
                    const data = doc.data();
                    data.id = doc.id;
                    driversCache[doc.id] = data;
                    allDrivers.push(data);

                    // Dropdown
                    if(!select.querySelector(`option[value="${doc.id}"]`)) {
                        const opt = document.createElement("option");
                        opt.value = doc.id;
                        opt.text = `${data.name} (${data.team})`;
                        select.appendChild(opt);
                    }

                    // Manage List
                    const div = document.createElement("div");
                    div.className = "driver-item";
                    div.innerHTML = `<div><strong>${data.name}</strong> <small>(${data.team})</small></div> <button class="delete-btn" onclick="deleteDriver('${doc.id}', '${data.name}')">DELETE</button>`;
                    list.appendChild(div);
                });

                updateLiveTables();
            });
        }

        // LOAD DRIVER DATA
        window.loadDriverData = () => {
            const id = document.getElementById("editorDriverSelect").value;
            const grid = document.getElementById("trackGrid");
            const area = document.getElementById("editor-area");
            
            if(!id) { area.style.display = "none"; return; }
            area.style.display = "block";
            grid.innerHTML = "";

            const data = driversCache[id];
            const results = data.results || {};

            TRACKS.forEach(t => {
                // Handle new vs old data structure
                let pts = 0;
                let team = data.team; // Default to their contract team

                if(results[t.id]) {
                    if(typeof results[t.id] === 'object') {
                        pts = results[t.id].points || 0;
                        team = results[t.id].team || data.team;
                    } else {
                        pts = results[t.id]; // Old format
                    }
                }

                // Build Team Dropdown for this track
                let teamOpts = TEAMS.map(tm => `<option value="${tm.id}" ${tm.id === team ? 'selected':''}>${tm.name}</option>`).join('');

                const div = document.createElement("div");
                div.className = "track-input";
                div.innerHTML = `
                    <label>${t.name}</label>
                    <div class="row-inputs">
                        <input type="number" class="points-input" data-track="${t.id}" value="${pts}" oninput="calcTotal()">
                        <select class="team-input" id="team-${t.id}">
                            ${teamOpts}
                        </select>
                    </div>
                `;
                grid.appendChild(div);
            });
            calcTotal();
        };

        // CALCULATE TOTAL (UI Only)
        window.calcTotal = () => {
            let sum = 0;
            document.querySelectorAll(".points-input").forEach(i => sum += Number(i.value) || 0);
            document.getElementById("calculatedTotal").innerText = sum;
        };

        // SAVE
        window.saveAllChanges = async () => {
            const id = document.getElementById("editorDriverSelect").value;
            const status = document.getElementById("editor-status");
            const pointsInputs = document.querySelectorAll(".points-input");
            const teamInputs = document.querySelectorAll(".team-input");
            
            status.innerText = "Saving...";
            
            let newResults = {};
            let newTotal = 0;

            pointsInputs.forEach((input, idx) => {
                const val = Number(input.value);
                const track = input.dataset.track;
                const team = teamInputs[idx].value;

                if(val > 0) {
                    newResults[track] = { points: val, team: team };
                    newTotal += val;
                }
            });

            try {
                await updateDoc(doc(db, "standings", id), {
                    results: newResults,
                    totalPoints: newTotal
                });
                status.style.color = "#00ff00";
                status.innerText = "SAVED SUCCESSFULLY!";
                setTimeout(() => status.innerText = "", 2000);
            } catch(e) {
                console.error(e);
                status.style.color = "red";
                status.innerText = "ERROR SAVING";
            }
        };

        // LIVE TABLES LOGIC (UPDATED FOR RESERVE DISPLAY)
        function updateLiveTables() {
            // 1. Drivers Table
            const dTable = document.getElementById("liveDriversBody");
            dTable.innerHTML = "";
            
            allDrivers.forEach((d, i) => {
                // Determine team display name
                let teamDisplay = TEAMS.find(t => t.id === d.team)?.name || d.team;
                
                // If reserve, verify which teams they actually drove for
                if(d.team === 'reserve') {
                    const drivenTeams = new Set();
                    if(d.results) {
                        Object.values(d.results).forEach(r => {
                            if(typeof r === 'object' && r.team && r.team !== 'reserve') {
                                const tName = TEAMS.find(t => t.id === r.team)?.name || r.team;
                                drivenTeams.add(tName);
                            }
                        });
                    }
                    if(drivenTeams.size > 0) {
                        teamDisplay = `Reserve <span style="font-size:0.75em; color:#aaa; margin-left:5px;">(for ${Array.from(drivenTeams).join(', ')})</span>`;
                    }
                }

                dTable.innerHTML += `
                    <tr>
                        <td>${i+1}</td>
                        <td>
                            <div style="font-weight:bold">${d.name}</div>
                            <div style="font-size:0.85rem; color:#888; text-transform:uppercase">${teamDisplay}</div>
                        </td>
                        <td style="text-align:right; font-weight:bold; font-size:1.1rem;">${d.totalPoints}</td>
                    </tr>
                `;
            });

            // 2. Constructors Table
            const teamPoints = {};
            
            allDrivers.forEach(d => {
                const results = d.results || {};
                Object.values(results).forEach(r => {
                    // Check if result has team info (new format) or assume driver team (old format)
                    let p = 0;
                    let t = d.team; 

                    if(typeof r === 'object') {
                        p = r.points || 0;
                        t = r.team || d.team;
                    } else {
                        p = r;
                    }

                    // Only count if it's a real team (not reserve category)
                    if(t !== 'reserve') {
                        if(!teamPoints[t]) teamPoints[t] = 0;
                        teamPoints[t] += p;
                    }
                });
            });

            // Sort & Render
            const sortedTeams = Object.keys(teamPoints).map(k => ({name: k, pts: teamPoints[k]})).sort((a,b) => b.pts - a.pts);
            const cTable = document.getElementById("liveConstructorsBody");
            cTable.innerHTML = "";
            sortedTeams.forEach((tm, i) => {
                const prettyName = TEAMS.find(t => t.id === tm.name)?.name || tm.name;
                cTable.innerHTML += `<tr><td>${i+1}</td><td style="text-transform:uppercase">${prettyName}</td><td style="text-align:right; font-weight:bold">${tm.pts}</td></tr>`;
            });
        }

        // REGISTER
        window.registerDriver = async () => {
            const name = document.getElementById("newDriverName").value;
            const team = document.getElementById("newDriverTeam").value;
            if(!name) return;
            
            try {
                await addDoc(colRef, { name, team, totalPoints: 0, results: {} });
                document.getElementById("newDriverName").value = "";
                document.getElementById("register-status").innerText = "Driver Added!";
            } catch(e) { console.error(e); }
        };

        // DELETE
        window.deleteDriver = async (id, name) => {
            if(confirm(`Delete ${name}?`)) await deleteDoc(doc(db, "standings", id));
        };
    </script>
</body>
</html>
