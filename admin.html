<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TTRL Pitwall | Mission Control</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700;800&family=JetBrains+Mono:wght@400;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-deep: #030305;
            --panel-bg: rgba(20, 20, 25, 0.95);
            --neon-cyan: #00f3ff;
            --neon-red: #ff003c;
            --neon-green: #00ff9d;
            --text-main: #e0e0e0;
            --text-dim: #6e6e7a;
            --glass-border: 1px solid rgba(255, 255, 255, 0.08);
            --tech-font: 'Rajdhani', sans-serif;
            --mono-font: 'JetBrains Mono', monospace;
        }

        * { box-sizing: border-box; outline: none; }

        body {
            background-color: var(--bg-deep);
            color: var(--text-main);
            font-family: var(--tech-font);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            background-image: 
                linear-gradient(rgba(3, 3, 5, 0.9), rgba(3, 3, 5, 0.95)),
                url('https://raw.githubusercontent.com/S-HARISH44/TTRL/452f1b2138a6e81e13d957a448e4de317d9f8201/RESOURCES/f1-cars-race-track-3840x2160-13489.jpg');
            background-size: cover;
            background-attachment: fixed;
            background-position: center;
            overflow-x: hidden;
        }

        /* --- DECORATIVE BACKGROUND GRID --- */
        body::before {
            content: "";
            position: fixed; inset: 0; pointer-events: none;
            background-image: 
                linear-gradient(var(--glass-border) 1px, transparent 1px),
                linear-gradient(90deg, var(--glass-border) 1px, transparent 1px);
            background-size: 40px 40px;
            opacity: 0.15;
            z-index: 0;
        }

        /* --- CUSTOM MODAL & TOAST --- */
        .custom-modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px);
            display: none; justify-content: center; align-items: center; z-index: 10000;
        }
        .custom-modal-box {
            background: #111; border: 1px solid var(--neon-cyan); padding: 25px;
            max-width: 400px; width: 90%; text-align: center;
            box-shadow: 0 0 30px rgba(0, 243, 255, 0.2);
            clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
        }
        .modal-msg { font-size: 1.1rem; margin-bottom: 20px; color: #fff; }
        .modal-btns { display: flex; gap: 10px; justify-content: center; }
        
        .toast-notification {
            position: fixed; bottom: 20px; right: 20px; background: rgba(0,0,0,0.9);
            border-left: 4px solid var(--neon-cyan); color: #fff; padding: 15px 25px;
            font-family: var(--mono-font); font-size: 0.9rem; z-index: 10001;
            transform: translateY(100px); opacity: 0; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .toast-visible { transform: translateY(0); opacity: 1; }

        /* --- LOGIN --- */
        #login-overlay {
            position: fixed; inset: 0; z-index: 9999;
            background-image: linear-gradient(rgba(3, 3, 5, 0.6), rgba(3, 3, 5, 0.9)), url('https://raw.githubusercontent.com/S-HARISH44/TTRL/452f1b2138a6e81e13d957a448e4de317d9f8201/RESOURCES/1-w-GettyImages-2048270135.webp');
            background-size: cover; background-position: center;
            display: flex; justify-content: center; align-items: center; transition: opacity 0.4s ease;
        }
        .login-box {
            width: 100%; max-width: 420px; background: rgba(10, 10, 15, 0.9); border: 1px solid var(--neon-cyan);
            padding: 3rem 2rem; position: relative; box-shadow: 0 0 40px rgba(0, 243, 255, 0.1);
            clip-path: polygon(20px 0, 100% 0, 100% calc(100% - 20px), calc(100% - 20px) 100%, 0 100%, 0 20px);
        }
        .login-logo { height: 60px; display: block; margin: 0 auto 1.5rem; }
        .login-title { text-align: center; font-size: 1.5rem; letter-spacing: 0.2em; color: var(--neon-cyan); margin-bottom: 2rem; font-weight: 700; }
        .login-input { width: 100%; background: rgba(0,0,0,0.5); border: 1px solid #333; color: #fff; padding: 12px; margin-bottom: 15px; font-family: var(--mono-font); }
        .btn-main { width: 100%; padding: 12px; background: var(--neon-cyan); color: #000; border: none; font-family: var(--tech-font); font-weight: 800; font-size: 1.1rem; cursor: pointer; text-transform: uppercase; clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px); }
        .btn-main:hover { background: #fff; }
        .btn-google { background: #fff; color: #000; margin-bottom: 1.5rem; display: flex; align-items: center; justify-content: center; gap: 10px; }

        /* --- MAIN UI --- */
        .container { max-width: 1400px; margin: 0 auto; display: none; padding: 20px; animation: fadeIn 0.5s; }
        header { display: flex; justify-content: space-between; align-items: center; padding: 1.5rem 0; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 2rem; }
        .header-logo { height: 40px; margin-right: 15px; }
        .header-title { font-size: 1.8rem; font-weight: 800; color: #fff; }
        
        .control-bar { background: rgba(255,0,60,0.05); border-left: 4px solid var(--neon-red); padding: 1rem; margin-bottom: 2rem; display: flex; flex-wrap: wrap; gap: 15px; align-items: center; }
        .flat-input { background: transparent; border: none; border-bottom: 1px solid #555; color: #fff; font-family: var(--mono-font); padding: 5px; }
        .btn-small { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); color: #ccc; padding: 6px 15px; cursor: pointer; font-family: var(--mono-font); text-transform: uppercase; }
        .btn-small:hover { background: #fff; color: #000; }
        .btn-accent { border-color: var(--neon-red); color: var(--neon-red); }
        .btn-accent:hover { background: var(--neon-red); color: #fff; }
        .btn-upload { border-color: var(--neon-green); color: var(--neon-green); }
        .btn-upload:hover { background: var(--neon-green); color: #000; }

        .nav-container { display: flex; gap: 2px; overflow-x: auto; margin-bottom: 20px; }
        .tab-btn { flex: 1; padding: 12px; background: rgba(255,255,255,0.03); border: none; color: #666; font-family: var(--tech-font); font-weight: 700; cursor: pointer; white-space: nowrap; }
        .tab-btn.active { background: var(--neon-cyan); color: #000; }

        .section { display: none; }
        .section.active { display: block; animation: slideUp 0.3s; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .panel-card { background: var(--panel-bg); border: var(--glass-border); padding: 20px; margin-bottom: 20px; }
        .panel-title { color: var(--neon-cyan); font-size: 1.2rem; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px; }

        /* Inputs & Tables */
        .input-module { background: rgba(0,0,0,0.3); border: 1px solid #333; padding: 10px; margin-bottom: 10px; }
        .input-module label { display: block; font-size: 0.7rem; color: #888; margin-bottom: 5px; font-family: var(--mono-font); }
        .data-input, select { width: 100%; background: transparent; border: 1px solid #444; color: #fff; padding: 8px; font-family: var(--mono-font); }
        .data-input:focus, select:focus { border-color: var(--neon-cyan); outline: none; }
        select option { background: #000; }

        .track-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; }
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .stat-box { border: 1px solid #333; padding: 15px; text-align: center; }
        .stat-num { font-size: 2rem; font-weight: 800; color: #fff; }

        .tech-table { width: 100%; border-collapse: collapse; font-family: var(--mono-font); font-size: 0.85rem; }
        .tech-table th { text-align: left; padding: 10px; color: #666; border-bottom: 1px solid #333; }
        .tech-table td { padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); color: #ccc; }

        /* List Items */
        .track-list-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: rgba(255,255,255,0.02); margin-bottom: 5px; border: 1px solid transparent; }
        .track-list-item:hover { border-color: var(--neon-cyan); }
        
        .driver-row { display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(255,255,255,0.02); border-bottom: 1px solid #222; }
        .driver-row:hover { background: rgba(255,255,255,0.05); }

        /* Validation Status */
        .status-valid { color: var(--neon-green); }
        .status-invalid { color: var(--neon-red); }
        .invalid-row { background: rgba(255, 0, 60, 0.1); }

        /* Date Picker Reset */
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; }
    </style>
</head>
<body>

    <!-- CUSTOM CONFIRMATION MODAL -->
    <div id="confirmModal" class="custom-modal-overlay">
        <div class="custom-modal-box">
            <div id="modalTitle" style="color:var(--neon-red); font-weight:bold; margin-bottom:10px;">CONFIRM ACTION</div>
            <div id="modalMessage" class="modal-msg">Are you sure?</div>
            <div class="modal-btns">
                <button id="btnConfirmYes" class="btn-main" style="width:100px; background:var(--neon-red); color:#fff;">YES</button>
                <button onclick="closeModal()" class="btn-main" style="width:100px; background:#333; color:#fff;">NO</button>
            </div>
        </div>
    </div>

    <!-- TOAST NOTIFICATION -->
    <div id="toast" class="toast-notification">Notification</div>

    <!-- LOGIN -->
    <div id="login-overlay">
        <div class="login-box">
            <img src="https://raw.githubusercontent.com/S-HARISH44/TTRL/452f1b2138a6e81e13d957a448e4de317d9f8201/RESOURCES/image.png" class="login-logo" alt="TTRL">
            <div class="login-title">SYSTEM ACCESS</div>
            <button class="btn-main btn-google" onclick="loginWithGoogle()"><i class="fab fa-google"></i> Login with Google</button>
            <div class="divider"><span>OR MANUAL ENTRY</span></div>
            <input type="email" id="loginEmail" class="login-input" placeholder="OPERATOR ID">
            <input type="password" id="loginPass" class="login-input" placeholder="SECURITY KEY">
            <button class="btn-main" onclick="checkLogin()">INITIATE LINK</button>
            <div id="login-msg" style="margin-top:20px; font-family:'JetBrains Mono'; font-size:0.8rem; color:var(--neon-red); text-align: center;"></div>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div class="container" id="main-interface">
        <header>
            <div class="header-left">
                <img src="https://raw.githubusercontent.com/S-HARISH44/TTRL/452f1b2138a6e81e13d957a448e4de317d9f8201/RESOURCES/image.png" class="header-logo" alt="TTRL">
                <div>
                    <div class="header-title">PITWALL <span style="color:var(--neon-cyan)">CONTROL</span></div>
                    <div class="header-subtitle">ADMINISTRATION CONSOLE</div>
                </div>
            </div>
            <div style="text-align:right;">
                <div style="font-size:0.8rem; color:#888;">OPERATOR</div>
                <div id="userName" style="color:#fff; font-weight:700;">UNKNOWN</div>
                <button class="btn-small" onclick="logout()" style="margin-top:5px; border-color:var(--neon-red); color:var(--neon-red);">EXIT</button>
            </div>
        </header>

        <div class="control-bar">
            <span class="control-label">DATA STREAM:</span>
            <input type="text" id="seasonInput" class="flat-input" value="season_1" placeholder="SEASON ID">
            <button class="btn-small btn-accent" onclick="changeSeason()"><i class="fas fa-sync"></i> SYNC</button>
            <button class="btn-small btn-upload" onclick="triggerImport()" style="margin-left: 20px;"><i class="fas fa-file-csv"></i> IMPORT DATA</button>
            <input type="file" id="csvFile" accept=".csv" style="display:none" onchange="handleFileSelect(this)">
            <button class="btn-small" onclick="exportData()" style="margin-left:auto;"><i class="fas fa-download"></i> EXPORT JSON</button>
        </div>
        <div id="knownSeasonsList" style="margin-bottom:20px; padding-left:10px; font-size:0.8rem; color:#666; font-family:var(--mono-font);"></div>

        <div class="nav-container">
            <button class="tab-btn active" onclick="switchTab('season-setup')">Season Setup</button>
            <button class="tab-btn" onclick="switchTab('manage-drivers')">Manage Grid</button>
            <button class="tab-btn" onclick="switchTab('race-director')">Race Director</button>
            <button class="tab-btn" onclick="switchTab('driver-editor')">Edit Driver</button>
            <button class="tab-btn" onclick="switchTab('live-view')">Live Data</button>
            <button class="tab-btn" onclick="switchTab('driver-stats')">Statistics</button>
        </div>

        <!-- 0. SEASON SETUP -->
        <div id="season-setup" class="section active">
            <div class="panel-card">
                <div class="panel-title" style="display:flex; justify-content:space-between; align-items:center;">
                    TRACK CONFIGURATION
                    <div>
                        <button class="btn-small" onclick="toggleTrackSelectAll()">SELECT ALL</button>
                        <button class="btn-small" onclick="deleteSelectedTracks()" style="border-color:var(--neon-red); color:var(--neon-red);">DELETE SELECTED</button>
                    </div>
                </div>
                <div style="display:grid; grid-template-columns: 2fr 1fr auto; gap:15px; margin-bottom:20px; align-items:end;">
                    <div class="input-module">
                        <label>SELECT TRACK</label>
                        <select id="trackSelector"><option value="">-- CHOOSE --</option></select>
                    </div>
                    <div class="input-module">
                        <label>DATE</label>
                        <input type="date" class="data-input" id="newTrackDate">
                    </div>
                    <button class="btn-main" onclick="addTrackConfig()" style="height:42px; width:auto; padding:0 30px;"><i class="fas fa-plus"></i></button>
                </div>
                <div id="trackConfigList" style="max-height:400px; overflow-y:auto; border-top:1px solid #333; padding-top:10px;"></div>
            </div>
        </div>

        <!-- 1. MANAGE GRID -->
        <div id="manage-drivers" class="section">
            <div class="panel-card">
                <div class="panel-title">ADD DRIVER</div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                    <input type="text" class="data-input" id="newDriverName" placeholder="DRIVER NAME">
                    <select id="newDriverTeam" class="data-input"></select>
                </div>
                <button class="btn-main" onclick="registerDriver()" style="margin-top:15px;">ADD ENTRY</button>
            </div>
            <div class="panel-card">
                <div class="panel-title" style="display:flex; justify-content:space-between;">
                    ACTIVE GRID
                    <div>
                        <button class="btn-small" onclick="toggleSelectAll()">SELECT ALL</button>
                        <button class="btn-small" onclick="deleteSelectedDrivers()" style="border-color:var(--neon-red); color:var(--neon-red);">DELETE SELECTED</button>
                    </div>
                </div>
                <div id="driverList" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap:10px;"></div>
            </div>
        </div>

        <!-- 2. RACE DIRECTOR -->
        <div id="race-director" class="section">
            <div class="panel-card">
                <div class="panel-title">RACE RESULTS</div>
                <select id="raceDirectorTrackSelect" onchange="loadRaceGrid()" style="margin-bottom:15px; background:rgba(0,0,0,0.5);"><option>Loading...</option></select>
                <div id="raceDirectorGrid" style="display:none;">
                    <div class="race-header-row"><span>DRIVER</span><span>POINTS</span></div>
                    <div id="raceInputsContainer" style="max-height:500px; overflow-y:auto; background:#050505; border:1px solid #333; margin-bottom:15px;"></div>
                    <button class="btn-main" onclick="saveRaceResults()">COMMIT RESULTS</button>
                </div>
            </div>
        </div>

        <!-- 3. EDIT DRIVER -->
        <div id="driver-editor" class="section">
            <div class="panel-card">
                <div class="panel-title">INDIVIDUAL ADJUSTMENT</div>
                <select id="editorDriverSelect" onchange="loadDriverData()" style="margin-bottom:20px;"></select>
                <div id="editor-area" style="display:none;">
                    <div class="input-module" style="margin-bottom:20px;">
                        <label>CURRENT MAIN CONTRACT</label>
                        <select id="editorMainTeam" class="data-input" onchange="updateMainTeam()"></select>
                    </div>
                    <div class="track-grid" id="trackGrid"></div>
                    <div style="margin-top:20px; text-align:right; font-size:1.2rem; color:var(--neon-cyan);">TOTAL: <span id="calculatedTotal">0</span></div>
                    <button class="btn-main" onclick="saveAllChanges()" style="margin-top:20px;">SAVE CHANGES</button>
                </div>
            </div>
        </div>

        <!-- 4. LIVE VIEW -->
        <div id="live-view" class="section">
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap:20px;">
                <div class="panel-card">
                    <div class="panel-title" style="color:var(--neon-cyan)">DRIVERS STANDINGS</div>
                    <div style="max-height:600px; overflow-y:auto;"><table class="tech-table"><tbody id="liveDriversBody"></tbody></table></div>
                </div>
                <div class="panel-card">
                    <div class="panel-title" style="color:var(--neon-red)">CONSTRUCTORS</div>
                    <div style="max-height:600px; overflow-y:auto;"><table class="tech-table"><tbody id="liveConstructorsBody"></tbody></table></div>
                </div>
            </div>
        </div>

        <!-- 5. STATS -->
        <div id="driver-stats" class="section">
            <div class="panel-card">
                <select id="statsDriverSelect" onchange="viewDriverStats()" style="margin-bottom:20px;"></select>
                <div id="statsDisplay" style="display:none;">
                    <h2 id="statsDriverName" style="font-size:2.5rem; margin:0;">NAME</h2>
                    <div id="statsTeamName" style="color:var(--neon-red); margin-bottom:20px;">TEAM</div>
                    <div class="stats-grid">
                        <div class="stat-box"><div class="stat-num" id="statPoints">0</div><div>PTS</div></div>
                        <div class="stat-box"><div class="stat-num" id="statWins" style="color:var(--neon-cyan)">0</div><div>WINS</div></div>
                        <div class="stat-box"><div class="stat-num" id="statPodiums">0</div><div>PODIUMS</div></div>
                        <div class="stat-box"><div class="stat-num" id="statAvg">0</div><div>AVG</div></div>
                    </div>
                    <div class="panel-title" style="margin-top:20px;">HISTORY</div>
                    <table class="tech-table"><tbody id="statsHistoryBody"></tbody></table>
                </div>
            </div>
        </div>

        <!-- IMPORT PREVIEW -->
        <div id="import-preview" class="section">
            <div class="panel-card">
                <div class="panel-title" style="color:var(--neon-green)">IMPORT REVIEW</div>
                <div style="margin-bottom:15px; font-size:0.9rem; color:#888;">Detected Tracks: <span id="detectedTracksList" style="color:var(--neon-green)"></span></div>
                <div style="max-height:500px; overflow-y:auto; border:1px solid #333; margin-bottom:15px;">
                    <table class="tech-table"><thead><tr><th>DRIVER</th><th>TEAM</th><th>PTS</th><th>STATUS</th></tr></thead><tbody id="importTableBody"></tbody></table>
                </div>
                <div style="display:flex; gap:10px;">
                    <button class="btn-main" onclick="commitImport()" style="background:var(--neon-green);">CONFIRM</button>
                    <button class="btn-main" onclick="cancelImport()" style="background:#333; color:#fff;">CANCEL</button>
                </div>
            </div>
        </div>

    </div>

    <!-- LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, getDoc, setDoc, query, orderBy, onSnapshot, writeBatch, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyApUD33ao9DfFa8IAfA2qby3IFKhLtcNFU",
            authDomain: "ttrl-9f3ef.firebaseapp.com",
            projectId: "ttrl-9f3ef",
            storageBucket: "ttrl-9f3ef.firebasestorage.app",
            messagingSenderId: "51144639440",
            appId: "1:51144639440:web:8a027b773bc2cddefe2fd5"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let currentSeason = "season_1"; 
        let unsubscribe = null; 
        let knownSeasons = [];
        let activeTracks = []; 
        try { knownSeasons = JSON.parse(localStorage.getItem('ttrl_seasons')) || ['season_1']; } catch(e) { knownSeasons = ['season_1']; }

        const TEAMS = [
            {id:'red-bull-racing', name:'Red Bull'}, {id:'ferrari', name:'Ferrari'}, {id:'mercedes', name:'Mercedes'},
            {id:'mclaren', name:'McLaren'}, {id:'aston-martin', name:'Aston Martin'}, {id:'alpine', name:'Alpine'},
            {id:'williams', name:'Williams'}, {id:'racing-bulls', name:'Racing Bulls'}, {id:'kick-sauber', name:'Kick Sauber'},
            {id:'haas', name:'Haas'}, {id:'reserve', name:'Reserve'}
        ];

        const MASTER_TRACK_LIST = [
            { id: "bahrain", name: "Bahrain GP" }, { id: "saudi_arabia", name: "Saudi Arabian GP" }, { id: "australia", name: "Australian GP" },
            { id: "japan", name: "Japanese GP" }, { id: "china", name: "Chinese GP" }, { id: "miami", name: "Miami GP" },
            { id: "emilia_romagna", name: "Emilia Romagna GP" }, { id: "monaco", name: "Monaco GP" }, { id: "canada", name: "Canadian GP" },
            { id: "spain", name: "Spanish GP" }, { id: "austria", name: "Austrian GP" }, { id: "uk", name: "British GP" },
            { id: "hungary", name: "Hungarian GP" }, { id: "belgium", name: "Belgian GP" }, { id: "netherlands", name: "Dutch GP" },
            { id: "italy", name: "Italian GP" }, { id: "azerbaijan", name: "Azerbaijan GP" }, { id: "singapore", name: "Singapore GP" },
            { id: "usa", name: "United States GP" }, { id: "mexico", name: "Mexico City GP" }, { id: "brazil", name: "SÃ£o Paulo GP" },
            { id: "las_vegas", name: "Las Vegas GP" }, { id: "qatar", name: "Qatar GP" }, { id: "abu_dhabi", name: "Abu Dhabi GP" }
        ];

        let driversCache = {};
        let allDrivers = [];
        let pendingImportData = [];
        let pendingImportTracks = new Set();

        // --- CUSTOM UI HELPERS ---
        window.showToast = (msg) => {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.add('toast-visible');
            setTimeout(() => t.classList.remove('toast-visible'), 3000);
        };

        window.customConfirm = (msg, onYes) => {
            const m = document.getElementById('confirmModal');
            document.getElementById('modalMessage').innerText = msg;
            m.style.display = 'flex';
            document.getElementById('btnConfirmYes').onclick = () => {
                m.style.display = 'none';
                onYes();
            };
        };
        window.closeModal = () => document.getElementById('confirmModal').style.display = 'none';

        // --- AUTH ---
        window.checkLogin = () => {
            const email = document.getElementById("loginEmail").value;
            const pass = document.getElementById("loginPass").value;
            signInWithEmailAndPassword(auth, email, pass).catch(e => document.getElementById("login-msg").innerText = "LOGIN FAILED");
        };
        window.loginWithGoogle = () => signInWithPopup(auth, new GoogleAuthProvider()).catch(e => console.error(e));
        window.logout = () => signOut(auth).then(() => window.location.reload());

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById("login-overlay").style.display = "none";
                document.getElementById("main-interface").style.display = "block";
                document.getElementById("userName").innerText = (user.displayName || user.email.split('@')[0]).toUpperCase(); 
                initApp();
            } else {
                document.getElementById("login-overlay").style.display = "flex";
                document.getElementById("main-interface").style.display = "none";
            }
        });

        // --- INIT ---
        function initApp() {
            renderKnownSeasons();
            populateDropdowns();
            changeSeason();
        }

        function populateDropdowns() {
            const ts = document.getElementById("trackSelector");
            ts.innerHTML = '<option value="">-- CHOOSE CIRCUIT --</option>';
            MASTER_TRACK_LIST.forEach(t => ts.innerHTML += `<option value="${t.id}">${t.name.toUpperCase()}</option>`);

            const teamOptions = TEAMS.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
            document.getElementById("newDriverTeam").innerHTML = teamOptions;
            document.getElementById("editorMainTeam").innerHTML = teamOptions;
        }

        // --- NAVIGATION ---
        window.switchTab = (id) => {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            
            const target = document.getElementById(id);
            if(target) target.classList.add('active');
            
            const btn = document.querySelector(`.tab-btn[onclick="switchTab('${id}')"]`);
            if(btn) btn.classList.add('active');
        };

        window.changeSeason = async () => {
            const inputVal = document.getElementById("seasonInput").value.trim().toLowerCase().replace(/\s+/g, '_');
            if(!inputVal) return;
            currentSeason = inputVal;
            if(!knownSeasons.includes(currentSeason)) {
                knownSeasons.push(currentSeason);
                localStorage.setItem('ttrl_seasons', JSON.stringify(knownSeasons));
                renderKnownSeasons();
            }
            await loadTrackConfig();
            initListener(); 
        };

        function renderKnownSeasons() {
            const c = document.getElementById("knownSeasonsList");
            c.innerHTML = "HISTORY: " + knownSeasons.map(s => `<span class="season-tag" style="cursor:pointer; border-bottom:1px solid #666; margin-right:10px;" onclick="document.getElementById('seasonInput').value='${s}';changeSeason()">${s}</span>`).join(' ');
        }

        // --- TRACK CONFIG ---
        async function loadTrackConfig() {
            const list = document.getElementById("trackConfigList");
            const docRef = doc(db, "seasons", currentSeason);
            try {
                const snap = await getDoc(docRef);
                activeTracks = (snap.exists() && snap.data().trackConfig) ? snap.data().trackConfig : [];
                activeTracks.sort((a, b) => new Date(a.date || '9999-12-31') - new Date(b.date || '9999-12-31'));
            } catch (e) { activeTracks = []; }

            if(activeTracks.length === 0) list.innerHTML = `<div style="text-align:center; color:#666; padding:20px;">NO TRACKS</div>`;
            else {
                list.innerHTML = activeTracks.map(t => `
                    <div class="track-list-item">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <input type="checkbox" class="track-checkbox" value="${t.id}">
                            <div>
                                <span class="track-code">${t.id.toUpperCase()}</span>
                                <span style="font-weight:bold; color:#fff;">${t.name}</span>
                            </div>
                        </div>
                        <div style="display:flex; gap:10px; align-items:center;">
                            <input type="date" value="${t.date || ''}" onchange="updateTrackDate('${t.id}', this.value)" style="background:transparent; border:1px solid #444; color:#fff; font-family:var(--mono-font); font-size:0.8rem; padding:4px;">
                            <button class="btn-small" onclick="removeTrackConfig('${t.id}')" style="border-color:var(--neon-red); color:var(--neon-red);">X</button>
                        </div>
                    </div>`).join('');
            }
            
            // Sync Race Director Dropdown
            const rs = document.getElementById("raceDirectorTrackSelect");
            rs.innerHTML = '<option value="">-- SELECT EVENT --</option>';
            activeTracks.forEach(t => rs.innerHTML += `<option value="${t.id}">${t.name.toUpperCase()}</option>`);
        }

        window.addTrackConfig = async () => {
            const id = document.getElementById("trackSelector").value;
            const date = document.getElementById("newTrackDate").value;
            if(!id || !date) { showToast("Select Track & Date"); return; }
            if(activeTracks.some(t => t.id === id)) { showToast("Track already exists"); return; }
            
            const obj = MASTER_TRACK_LIST.find(t => t.id === id);
            const newTrack = { id, name: obj.name, date };
            
            const ref = doc(db, "seasons", currentSeason);
            const snap = await getDoc(ref);
            if(!snap.exists()) await setDoc(ref, { trackConfig: [newTrack] });
            else await updateDoc(ref, { trackConfig: arrayUnion(newTrack) });
            
            loadTrackConfig(); showToast("Track Added");
        };

        window.updateTrackDate = async (trackId, newDate) => {
            const ref = doc(db, "seasons", currentSeason);
            const snap = await getDoc(ref);
            if(snap.exists()) {
                let tracks = snap.data().trackConfig || [];
                const idx = tracks.findIndex(t => t.id === trackId);
                if(idx !== -1) {
                    tracks[idx].date = newDate;
                    await updateDoc(ref, { trackConfig: tracks });
                    showToast("Date Updated");
                }
            }
        };

        window.removeTrackConfig = (id) => {
            customConfirm("Remove this track?", async () => {
                const ref = doc(db, "seasons", currentSeason);
                const snap = await getDoc(ref);
                if(snap.exists()) {
                    const tracks = snap.data().trackConfig.filter(t => t.id !== id);
                    await updateDoc(ref, { trackConfig: tracks });
                    loadTrackConfig(); showToast("Track Removed");
                }
            });
        };

        // NEW: Batch Delete Tracks
        window.toggleTrackSelectAll = () => {
            const cbs = document.querySelectorAll('.track-checkbox');
            const all = Array.from(cbs).every(c => c.checked);
            cbs.forEach(c => c.checked = !all);
        };

        window.deleteSelectedTracks = () => {
            const cbs = document.querySelectorAll('.track-checkbox:checked');
            if(cbs.length === 0) return;
            customConfirm(`Delete ${cbs.length} tracks?`, async () => {
                const idsToRemove = Array.from(cbs).map(c => c.value);
                const ref = doc(db, "seasons", currentSeason);
                const snap = await getDoc(ref);
                if(snap.exists()) {
                    const currentTracks = snap.data().trackConfig || [];
                    const newTracks = currentTracks.filter(t => !idsToRemove.includes(t.id));
                    await updateDoc(ref, { trackConfig: newTracks });
                    loadTrackConfig();
                    showToast("Tracks Deleted");
                }
            });
        };

        // --- DRIVER DATA ---
        function initListener() {
            if(unsubscribe) unsubscribe();
            const q = query(collection(db, "seasons", currentSeason, "drivers"), orderBy("totalPoints", "desc"));
            
            unsubscribe = onSnapshot(q, (snap) => {
                const list = document.getElementById("driverList");
                const editSel = document.getElementById("editorDriverSelect");
                const statSel = document.getElementById("statsDriverSelect");
                
                list.innerHTML = "";
                editSel.innerHTML = '<option value="">-- SELECT DRIVER --</option>';
                statSel.innerHTML = '<option value="">-- SELECT DRIVER --</option>';
                allDrivers = [];

                if(snap.empty) list.innerHTML = `<div style="padding:20px; text-align:center; color:#666;">GRID EMPTY</div>`;

                snap.forEach(d => {
                    const data = d.data();
                    data.id = d.id;
                    driversCache[d.id] = data;
                    allDrivers.push(data);

                    // Dropdowns
                    const label = data.name.toUpperCase();
                    editSel.innerHTML += `<option value="${d.id}">${label}</option>`;
                    statSel.innerHTML += `<option value="${d.id}">${label}</option>`;

                    // Grid List
                    const row = document.createElement("div");
                    row.className = "driver-row";
                    row.innerHTML = `
                        <input type="checkbox" class="driver-checkbox" value="${d.id}">
                        <div style="flex-grow:1;">
                            <div style="font-weight:bold; color:#fff;">${data.name}</div>
                            <div style="font-size:0.75rem; color:var(--neon-cyan); text-transform:uppercase;">${data.team}</div>
                        </div>
                        <button onclick="deleteDriver('${d.id}')" style="background:transparent; border:1px solid var(--neon-red); color:var(--neon-red); padding:5px 10px; cursor:pointer;">DEL</button>
                    `;
                    list.appendChild(row);
                });
                
                updateLiveTables();
                if(document.getElementById("raceDirectorGrid").style.display === "block") loadRaceGrid();
                if(document.getElementById("editor-area").style.display === "block") loadDriverData();
                if(document.getElementById("statsDisplay").style.display === "block") viewDriverStats();
            });
        }

        window.registerDriver = async () => {
            const name = document.getElementById("newDriverName").value;
            const team = document.getElementById("newDriverTeam").value;
            if(!name) return;
            try {
                await addDoc(collection(db, "seasons", currentSeason, "drivers"), { name, team, totalPoints: 0, results: {} });
                document.getElementById("newDriverName").value = "";
                showToast("Driver Added");
            } catch(e) { console.error(e); }
        };

        window.deleteDriver = (id) => {
            const d = driversCache[id];
            customConfirm(`Delete ${d ? d.name : 'driver'}?`, async () => {
                await deleteDoc(doc(db, "seasons", currentSeason, "drivers", id));
                showToast("Deleted");
            });
        };

        window.toggleSelectAll = () => {
            const cbs = document.querySelectorAll('.driver-checkbox');
            const all = Array.from(cbs).every(c => c.checked);
            cbs.forEach(c => c.checked = !all);
        };

        window.deleteSelectedDrivers = () => {
            const cbs = document.querySelectorAll('.driver-checkbox:checked');
            if(cbs.length === 0) return;
            customConfirm(`Delete ${cbs.length} drivers?`, async () => {
                const batch = writeBatch(db);
                cbs.forEach(c => batch.delete(doc(db, "seasons", currentSeason, "drivers", c.value)));
                await batch.commit();
                showToast("Batch Delete Complete");
            });
        };

        // --- EDITOR ---
        window.loadDriverData = () => {
            const id = document.getElementById("editorDriverSelect").value;
            const area = document.getElementById("editor-area");
            if(!id) { area.style.display = "none"; return; }
            area.style.display = "block";
            
            const data = driversCache[id];
            document.getElementById("editorMainTeam").value = data.team;
            
            const grid = document.getElementById("trackGrid");
            grid.innerHTML = "";
            
            if(activeTracks.length === 0) { grid.innerHTML = "No Tracks Configured"; return; }

            const res = data.results || {};
            
            // Build Enhanced Dropdown with Reserve Options
            let teamOpts = `<optgroup label="Standard Teams">`;
            teamOpts += TEAMS.map(tm => `<option value="${tm.id}">${tm.name}</option>`).join('');
            teamOpts += `</optgroup><optgroup label="Reserve / Sub Options">`;
            teamOpts += TEAMS.map(tm => `<option value="${tm.id}">Reserve - ${tm.name}</option>`).join('');
            teamOpts += `</optgroup>`;

            activeTracks.forEach(t => {
                let pts = 0;
                let raceTeam = data.team; 
                
                if(res[t.id]) {
                    if(typeof res[t.id] === 'object') {
                        pts = res[t.id].points || 0;
                        raceTeam = res[t.id].team || data.team;
                    } else { pts = res[t.id]; }
                }

                const div = document.createElement("div");
                div.className = "input-module";
                div.innerHTML = `
                    <label>${t.name.toUpperCase()}</label>
                    <div style="display:flex; gap:5px;">
                        <input type="number" class="pts-in data-input" style="width:60px; text-align:center; font-weight:bold; color:var(--neon-cyan);" data-track="${t.id}" value="${pts}" oninput="calcTotal()">
                        <select class="tm-in data-input" id="tm-${t.id}">
                            ${teamOpts}
                        </select>
                    </div>`;
                grid.appendChild(div);
                
                // Set value after HTML injection
                document.getElementById(`tm-${t.id}`).value = raceTeam;
            });
            calcTotal();
        };

        window.updateMainTeam = async () => {
            const id = document.getElementById("editorDriverSelect").value;
            const team = document.getElementById("editorMainTeam").value;
            await updateDoc(doc(db, "seasons", currentSeason, "drivers", id), { team });
            showToast("Main Contract Updated");
        };

        window.calcTotal = () => {
            let s = 0;
            document.querySelectorAll(".pts-in").forEach(i => s += Number(i.value)||0);
            document.getElementById("calculatedTotal").innerText = s;
        };

        window.saveAllChanges = async () => {
            const id = document.getElementById("editorDriverSelect").value;
            const ptsIns = document.querySelectorAll(".pts-in");
            const tmIns = document.querySelectorAll(".tm-in");
            
            let newResults = {};
            let total = 0;
            
            ptsIns.forEach((p, idx) => {
                const val = Number(p.value);
                if(val > 0) {
                    newResults[p.dataset.track] = { points: val, team: tmIns[idx].value };
                    total += val;
                }
            });

            await updateDoc(doc(db, "seasons", currentSeason, "drivers", id), { results: newResults, totalPoints: total });
            showToast("Driver Updated");
        };

        // --- IMPORT ---
        window.triggerImport = () => document.getElementById('csvFile').click();
        
        window.handleFileSelect = (input) => {
            if(input.files[0]) {
                const r = new FileReader();
                r.onload = (e) => parseCSV(e.target.result);
                r.readAsText(input.files[0]);
            }
        };

        function fuzzyMatch(h) {
            const l = h.toLowerCase();
            if(l.includes('bahrain')) return 'bahrain';
            if(l.includes('saudi')) return 'saudi_arabia';
            if(l.includes('australia')) return 'australia';
            if(l.includes('japan')) return 'japan';
            if(l.includes('china')) return 'china';
            if(l.includes('miami')) return 'miami';
            if(l.includes('imola') || l.includes('emilia')) return 'emilia_romagna';
            if(l.includes('monaco')) return 'monaco';
            if(l.includes('canada')) return 'canada';
            if(l.includes('spain') || l.includes('spanish')) return 'spain';
            if(l.includes('austria')) return 'austria';
            if(l.includes('britain') || l.includes('uk') || l.includes('silverstone')) return 'uk';
            if(l.includes('hungary')) return 'hungary';
            if(l.includes('belgium')) return 'belgium';
            if(l.includes('netherlands') || l.includes('dutch')) return 'netherlands';
            if(l.includes('italy') || l.includes('monza')) return 'italy';
            if(l.includes('azerbaijan') || l.includes('baku')) return 'azerbaijan';
            if(l.includes('singapore')) return 'singapore';
            if(l.includes('usa') || l.includes('austin')) return 'usa';
            if(l.includes('mexico')) return 'mexico';
            if(l.includes('brazil') || l.includes('paulo')) return 'brazil';
            if(l.includes('vegas')) return 'las_vegas';
            if(l.includes('qatar')) return 'qatar';
            if(l.includes('abu')) return 'abu_dhabi';
            return null;
        }

        function parseCSV(text) {
            const lines = text.split('\n');
            pendingImportData = [];
            pendingImportTracks.clear();
            
            const headers = lines[0].split(',').map(s => s.trim().replace(/^"|"$/g,''));
            const colMap = {};
            
            headers.forEach((h, i) => {
                const mid = fuzzyMatch(h);
                if(mid) { colMap[i] = mid; pendingImportTracks.add(mid); }
            });

            lines.slice(1).forEach(line => {
                if(!line.trim()) return;
                const p = line.split(',').map(s => s.trim().replace(/^"|"$/g,''));
                if(p.length < 2) return;

                const name = p[0];
                const teamRaw = p[1].toLowerCase().replace(/\s/g,'-');
                // fuzzy team match
                let teamId = 'reserve';
                const tObj = TEAMS.find(t => t.id === teamRaw || t.name.toLowerCase() === p[1].toLowerCase());
                if(tObj) teamId = tObj.id;

                let res = {}, tot = 0;
                Object.keys(colMap).forEach(idx => {
                    const pts = parseInt(p[idx]);
                    if(!isNaN(pts) && pts > 0) {
                        res[colMap[idx]] = { points: pts, team: teamId };
                        tot += pts;
                    }
                });

                pendingImportData.push({ name, team: teamId, results: res, totalPoints: tot, valid: true });
            });

            // Show UI
            switchTab('import-preview');
            document.getElementById('import-preview').classList.add('active');
            
            const div = document.getElementById('detectedTracksList');
            div.innerText = Array.from(pendingImportTracks).join(', ').toUpperCase() || "NONE";

            const tb = document.getElementById('importTableBody');
            tb.innerHTML = "";
            pendingImportData.forEach((d, i) => {
                const tr = document.createElement('tr');
                let tOpts = TEAMS.map(t => `<option value="${t.id}" ${t.id===d.team?'selected':''}>${t.name}</option>`).join('');
                tr.innerHTML = `
                    <td><input value="${d.name}" class="data-input" onchange="pendingImportData[${i}].name=this.value"></td>
                    <td><select onchange="pendingImportData[${i}].team=this.value; updateImpTeam(${i}, this.value)">${tOpts}</select></td>
                    <td style="color:var(--neon-cyan); font-weight:bold;">${d.totalPoints}</td>
                    <td class="status-valid">OK</td>
                `;
                tb.appendChild(tr);
            });
        }

        window.updateImpTeam = (idx, nt) => {
            const r = pendingImportData[idx].results;
            Object.keys(r).forEach(k => r[k].team = nt);
        };

        window.cancelImport = () => {
            document.getElementById('csvFile').value = "";
            switchTab('manage-drivers');
        };

        window.commitImport = async () => {
            // 1. Update Tracks
            const sRef = doc(db, "seasons", currentSeason);
            const snap = await getDoc(sRef);
            let tracks = (snap.exists() && snap.data().trackConfig) ? snap.data().trackConfig : [];
            
            const newT = [];
            pendingImportTracks.forEach(tid => {
                if(!tracks.some(t => t.id === tid)) {
                    const m = MASTER_TRACK_LIST.find(x => x.id === tid);
                    newT.push({ id: tid, name: m ? m.name : tid.toUpperCase(), date: "" });
                }
            });

            if(newT.length > 0) {
                if(snap.exists()) await updateDoc(sRef, { trackConfig: arrayUnion(...newT) });
                else await setDoc(sRef, { trackConfig: newT });
            }

            // 2. Add Drivers
            const batch = writeBatch(db);
            pendingImportData.forEach(d => {
                if(d.name) {
                    batch.set(doc(collection(db, "seasons", currentSeason, "drivers")), {
                        name: d.name, team: d.team, totalPoints: d.totalPoints, results: d.results
                    });
                }
            });

            await batch.commit();
            loadTrackConfig();
            cancelImport();
            showToast(`Imported ${pendingImportData.length} Drivers`);
        };

        // --- TABLES & RACE DIRECTOR ---
        // (Similar to previous versions but cleaner)
        function updateLiveTables() {
            const tD = document.getElementById("liveDriversBody");
            tD.innerHTML = "";
            const sorted = [...allDrivers].sort((a,b) => {
                if(a.team==='reserve' && b.team!=='reserve') return 1;
                if(a.team!=='reserve' && b.team==='reserve') return -1;
                return b.totalPoints - a.totalPoints;
            });
            sorted.forEach((d,i) => {
                tD.innerHTML += `<tr><td style="color:#666;">${String(i+1).padStart(2,'0')}</td><td><div style="font-weight:bold; color:#fff;">${d.name}</div><div style="font-size:0.7rem; color:var(--neon-cyan);">${d.team.toUpperCase()}</div></td><td style="text-align:right; font-weight:bold; font-size:1.1rem; color:var(--neon-cyan);">${d.totalPoints}</td></tr>`;
            });

            const teamPts = {};
            allDrivers.forEach(d => {
                const res = d.results || {};
                Object.values(res).forEach(r => {
                    const p = (typeof r === 'object') ? r.points : r;
                    const t = (typeof r === 'object') ? r.team : d.team;
                    if(t !== 'reserve') { teamPts[t] = (teamPts[t]||0) + p; }
                });
            });
            const tC = document.getElementById("liveConstructorsBody");
            tC.innerHTML = "";
            Object.keys(teamPts).map(k => ({id:k, p:teamPts[k]})).sort((a,b) => b.p - a.p).forEach((x,i) => {
                const tn = TEAMS.find(t=>t.id===x.id)?.name || x.id;
                tC.innerHTML += `<tr><td style="color:#666;">${String(i+1).padStart(2,'0')}</td><td style="font-weight:bold; color:#fff; text-transform:uppercase;">${tn}</td><td style="text-align:right; font-weight:bold; color:var(--neon-red);">${x.p}</td></tr>`;
            });
        }

        window.loadRaceGrid = () => {
            const tid = document.getElementById("raceDirectorTrackSelect").value;
            const con = document.getElementById("raceInputsContainer");
            const wrap = document.getElementById("raceDirectorGrid");
            if(!tid) { wrap.style.display="none"; return; }
            wrap.style.display="block";
            con.innerHTML = "";
            
            [...allDrivers].sort((a,b)=>a.name.localeCompare(b.name)).forEach(d => {
                const r = d.results || {};
                const pts = (r[tid] && typeof r[tid]==='object') ? r[tid].points : (r[tid] || 0);
                con.innerHTML += `<div class="race-input-row"><div class="driver-name-label">${d.name} <span style="color:#666; font-size:0.8rem;">(${d.team})</span></div><input type="number" class="race-points-input" data-did="${d.id}" value="${pts}"></div>`;
            });
        };

        window.saveRaceResults = async () => {
            const tid = document.getElementById("raceDirectorTrackSelect").value;
            if(!tid) return;
            const inps = document.querySelectorAll(".race-points-input");
            const batch = writeBatch(db);
            let changes = 0;

            inps.forEach(inp => {
                const did = inp.dataset.did;
                const newP = Number(inp.value);
                const d = driversCache[did];
                const oldRes = d.results || {};
                const oldP = (oldRes[tid] && typeof oldRes[tid]==='object') ? oldRes[tid].points : (oldRes[tid]||0);
                
                if(oldP !== newP) {
                    const newTot = d.totalPoints - oldP + newP;
                    const resUpd = { ...oldRes };
                    
                    // Maintain existing team logic for this track if present, else use current main team
                    let tRace = d.team;
                    if(oldRes[tid] && oldRes[tid].team) tRace = oldRes[tid].team;

                    if(newP > 0) resUpd[tid] = { points: newP, team: tRace };
                    else delete resUpd[tid];

                    batch.update(doc(db, "seasons", currentSeason, "drivers", did), { results: resUpd, totalPoints: newTot });
                    changes++;
                }
            });

            if(changes > 0) { await batch.commit(); showToast("Results Saved"); }
            else showToast("No Changes");
        };

        window.viewDriverStats = () => {
            const id = document.getElementById("statsDriverSelect").value;
            const disp = document.getElementById("statsDisplay");
            if(!id) { disp.style.display="none"; return; }
            disp.style.display="block";
            
            const d = driversCache[id];
            document.getElementById("statsDriverName").innerText = d.name.toUpperCase();
            document.getElementById("statsTeamName").innerText = TEAMS.find(t=>t.id===d.team)?.name.toUpperCase() || d.team;
            document.getElementById("statPoints").innerText = d.totalPoints;

            let w=0, p=0, r=0, hHTML="";
            activeTracks.forEach(t => {
                const res = d.results ? d.results[t.id] : null;
                if(res) {
                    const pt = res.points || res; // handle old format if any
                    const tm = res.team || d.team;
                    if(pt > 0) {
                        r++;
                        if(pt>=25) w++;
                        if(pt>=15) p++;
                        const tName = TEAMS.find(x=>x.id===tm)?.name || tm;
                        hHTML += `<tr><td>${t.name.toUpperCase()}</td><td style="color:#888;">${tName}</td><td style="text-align:right; font-weight:bold; color:var(--neon-cyan);">${pt}</td></tr>`;
                    }
                }
            });
            document.getElementById("statWins").innerText = w;
            document.getElementById("statPodiums").innerText = p;
            document.getElementById("statAvg").innerText = r>0 ? (d.totalPoints/r).toFixed(1) : "0.0";
            document.getElementById("statsHistoryBody").innerHTML = hHTML || `<tr><td colspan="3" style="text-align:center;">NO DATA</td></tr>`;
        };

    </script>
</body>
</html>
