<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TTRL Pitwall | Secure Access</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --bg-main: #050505;
            --accent-red: #ff1f4b;
            --accent-cyan: #00f0ff;
            --text-primary: #ffffff;
            --glass-border: rgba(255, 255, 255, 0.15);
            --glass-bg: rgba(20, 20, 20, 0.95);
            --card-bg: #0a0a0a;
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--bg-main);
            color: var(--text-primary);
            font-family: 'Rajdhani', sans-serif;
            margin: 0;
            padding: 20px;
            background-image: 
                linear-gradient(rgba(0, 240, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 240, 255, 0.03) 1px, transparent 1px);
            background-size: 30px 30px;
        }
        
        /* LOGIN OVERLAY */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(5, 5, 5, 0.95);
            backdrop-filter: blur(10px);
            z-index: 999;
            display: flex; justify-content: center; align-items: center;
            transition: opacity 0.5s;
        }
        .login-box {
            background: var(--glass-bg);
            padding: 3rem;
            border: 1px solid var(--accent-cyan);
            width: 100%; max-width: 400px;
            text-align: center;
            box-shadow: 0 0 50px rgba(0, 240, 255, 0.1);
            clip-path: polygon(20px 0, 100% 0, 100% calc(100% - 20px), calc(100% - 20px) 100%, 0 100%, 0 20px);
        }
        .divider {
            display: flex; align-items: center; margin: 20px 0; color: #666; font-size: 0.8rem; font-family: 'JetBrains Mono';
        }
        .divider::before, .divider::after {
            content: ''; flex: 1; height: 1px; background: #333;
        }
        .divider span { padding: 0 10px; }
        
        h1, h2, h3, h4 { margin: 0; text-transform: uppercase; letter-spacing: 0.05em; }
        
        /* LAYOUT */
        .container { max-width: 1200px; margin: 0 auto; display: none; animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--glass-border);
            padding-bottom: 20px; margin-bottom: 30px;
        }
        
        /* TABS */
        .nav-tabs { display: flex; gap: 5px; margin-bottom: 25px; border-bottom: 1px solid #333; overflow-x: auto; }
        .tab-btn {
            padding: 12px 25px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            color: #666;
            cursor: pointer;
            font-family: 'Rajdhani', sans-serif;
            font-size: 1.1rem;
            font-weight: 700;
            text-transform: uppercase;
            transition: 0.3s;
            white-space: nowrap;
        }
        .tab-btn:hover { color: #fff; }
        .tab-btn.active {
            color: var(--accent-cyan);
            border-bottom-color: var(--accent-cyan);
            background: linear-gradient(to top, rgba(0, 240, 255, 0.1), transparent);
        }

        .section { display: none; }
        .section.active { display: block; }
        
        /* FORMS & GRID */
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: var(--accent-cyan); font-size: 0.8rem; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; }
        
        input, select {
            width: 100%; padding: 12px 15px;
            background: rgba(255,255,255,0.05);
            border: 1px solid #333;
            color: #fff;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            transition: 0.3s;
        }
        /* Fix for white dropdown options */
        select option {
            background-color: #000;
            color: #fff;
        }
        input:focus, select:focus {
            outline: none;
            border-color: var(--accent-cyan);
            background: rgba(0, 240, 255, 0.05);
        }

        .track-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .track-input {
            background: var(--card-bg);
            padding: 15px;
            border: 1px solid #333;
            border-left: 3px solid #333;
            transition: border-color 0.3s;
        }
        .track-input:focus-within { border-left-color: var(--accent-cyan); }
        .track-input label { color: #888; font-size: 0.75rem; margin-bottom: 5px; }
        
        .row-inputs { display: flex; gap: 10px; }
        .points-input { width: 80px; text-align: center; color: var(--accent-cyan); font-weight: 700; }
        .team-input { flex-grow: 1; font-size: 0.8rem; color: #ccc; }

        /* TOTALS */
        .total-box {
            margin-top: 30px; padding: 20px;
            background: rgba(0, 240, 255, 0.05);
            border: 1px solid var(--accent-cyan);
            display: flex; justify-content: space-between; align-items: center;
        }
        .total-value { font-size: 2.5rem; font-weight: 800; color: #fff; font-family: 'Rajdhani'; }

        button.action-btn {
            width: 100%; padding: 15px;
            background: var(--accent-cyan);
            color: #000;
            border: none;
            font-family: 'Rajdhani', sans-serif;
            font-weight: 800;
            font-size: 1.1rem;
            cursor: pointer;
            text-transform: uppercase;
            margin-top: 10px;
            clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
            transition: 0.3s;
        }
        button.action-btn:hover {
            background: #fff;
            box-shadow: 0 0 20px var(--accent-cyan);
        }
        
        button.google-btn {
            background: #fff; color: #333; 
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        button.google-btn:hover { background: #eee; box-shadow: 0 0 15px rgba(255,255,255,0.3); }

        button.delete-btn {
            background: transparent;
            border: 1px solid var(--accent-red);
            color: var(--accent-red);
            padding: 5px 12px;
            cursor: pointer;
            font-size: 0.7rem;
            font-weight: 700;
            transition: 0.3s;
        }
        button.delete-btn:hover { background: var(--accent-red); color: #fff; }

        /* LIVE TABLES */
        .view-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9rem; font-family: 'JetBrains Mono'; }
        .view-table th {
            text-align: left; padding: 10px;
            background: #111; color: #888;
            font-family: 'Rajdhani'; font-weight: 700;
            border-bottom: 2px solid #333;
        }
        .view-table td { padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .view-table tr:hover td { background: rgba(255,255,255,0.02); }
        
        .driver-item {
            display: flex; justify-content: space-between; align-items: center;
            background: #111; padding: 12px; margin-bottom: 8px;
            border-left: 3px solid #333;
            transition: all 0.2s;
        }
        .driver-item:hover { border-left-color: var(--accent-cyan); background: #161616; transform: translateX(5px); }
        
        /* SEASON SELECTOR STYLE */
        .season-selector-container {
            background: linear-gradient(90deg, rgba(255, 31, 75, 0.1), transparent);
            padding: 15px; border-left: 4px solid var(--accent-red);
            margin-bottom: 30px; display: flex; align-items: center; gap: 15px;
        }
        .season-input { flex-grow: 1; border-color: var(--accent-red); }
        .season-btn {
            background: var(--accent-red); color: #fff; border: none; padding: 12px 25px; 
            font-weight: bold; cursor: pointer; text-transform: uppercase; 
            font-family: 'Rajdhani'; letter-spacing: 0.1em;
        }
        .season-btn:hover { background: #fff; color: var(--accent-red); }
        
        /* SAVED SEASONS LIST */
        #knownSeasonsList { display: flex; gap: 10px; margin-top: 5px; font-size: 0.8rem; color: #666; margin-bottom: 20px; }
        .season-tag { 
            cursor: pointer; border: 1px solid #333; padding: 2px 8px; 
            font-family: 'JetBrains Mono'; transition: 0.2s; 
        }
        .season-tag:hover { color: var(--accent-cyan); border-color: var(--accent-cyan); background: rgba(0, 240, 255, 0.1); }
        
        /* USER INFO */
        .user-badge { display: flex; align-items: center; gap: 15px; font-size: 0.9rem; color: #aaa; }
        .secure-badge {
            color: var(--accent-cyan); border: 1px solid var(--accent-cyan);
            padding: 2px 6px; font-size: 0.7rem; letter-spacing: 0.1em;
        }

        /* --- STATS DASHBOARD --- */
        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px; margin-bottom: 30px;
        }
        .stat-card {
            background: var(--card-bg); border: 1px solid var(--glass-border); padding: 20px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border-bottom: 3px solid var(--accent-cyan);
        }
        .stat-val { font-size: 2.5rem; font-weight: 800; color: #fff; font-family: 'Rajdhani'; line-height: 1; }
        .stat-label { color: #888; font-size: 0.8rem; letter-spacing: 0.1em; margin-top: 5px; text-transform: uppercase; }
        .stats-history-container { background: var(--glass-bg); padding: 20px; border: 1px solid #333; }
    </style>
</head>
<body>

    <!-- LOGIN OVERLAY -->
    <div id="login-overlay">
        <div class="login-box">
            <h2 style="color:var(--accent-cyan); margin-bottom: 10px;"><i class="fas fa-fingerprint"></i> PITWALL ACCESS</h2>
            <p style="color:#888; font-size:0.9rem; margin-bottom:30px; font-family:'JetBrains Mono';">RESTRICTED AREA // AUTH REQUIRED</p>
            
            <button class="action-btn google-btn" onclick="loginWithGoogle()">
                <i class="fab fa-google"></i> SIGN IN WITH GOOGLE
            </button>

            <div class="divider"><span>OR MANUAL LOGIN</span></div>

            <div class="form-group">
                <input type="email" id="loginEmail" placeholder="OPERATOR ID" style="margin-bottom:10px;">
                <input type="password" id="loginPass" placeholder="ACCESS KEY" style="margin-bottom:10px;">
            </div>
            
            <button class="action-btn" style="margin-top:0;" onclick="checkLogin()">AUTHENTICATE</button>
            
            <div id="login-msg" style="color:var(--accent-red); margin-top:20px; font-family:'JetBrains Mono'; font-size:0.8rem;"></div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div class="container" id="main-interface">
        <header>
            <div style="display:flex; align-items:center; gap:20px;">
                <h1 style="font-size:2.5rem; text-shadow:0 0 10px rgba(255,255,255,0.2);">TTRL <span style="color:var(--accent-cyan)">ADMIN</span></h1>
                <div class="secure-badge">SECURE CONNECTION</div>
            </div>
            <div class="user-badge">
                <span>OPERATOR: <span id="userName" style="color:#fff; font-weight:bold;">Admin</span></span>
                <button onclick="logout()" style="background:transparent; border:1px solid #555; color:#fff; padding:5px 15px; cursor:pointer; font-family:'Rajdhani'; font-weight:bold; font-size:0.8rem;">TERMINATE</button>
            </div>
        </header>

        <!-- SEASON SELECTOR -->
        <div class="season-selector-container">
            <label style="margin:0; font-weight:bold; color:var(--accent-red); font-size:1rem;">ACTIVE SEASON ID:</label>
            <input type="text" id="seasonInput" class="season-input" value="season_1" placeholder="ENTER SEASON IDENTIFIER...">
            <button class="season-btn" onclick="changeSeason()">LOAD DATA</button>
            <button class="season-btn" style="background: transparent; border: 1px solid var(--accent-red); color: var(--accent-red);" onclick="changeSeason()"><i class="fas fa-sync-alt"></i></button>
        </div>
        <div id="knownSeasonsList">
            <!-- JS Injected -->
        </div>

        <div class="nav-tabs">
            <button class="tab-btn active" onclick="switchTab('race-control')">Results Editor</button>
            <button class="tab-btn" onclick="switchTab('live-view')">Live Telemetry</button>
            <button class="tab-btn" onclick="switchTab('driver-stats')">Driver Statistics</button>
            <button class="tab-btn" onclick="switchTab('manage-drivers')">Grid Management</button>
        </div>

        <!-- 1. EDITOR -->
        <div id="race-control" class="section active">
            <h3 style="color:var(--accent-cyan); margin-bottom:10px;"><i class="fas fa-pen-square"></i> RESULT MODIFICATION</h3>
            <p style="color:#666; font-family:'JetBrains Mono'; font-size:0.9rem; margin-bottom:20px;">TARGET DATABASE: <span id="currentSeasonLabel" style="color:var(--accent-red); font-weight:bold;">season_1</span></p>
            
            <div class="form-group">
                <select id="editorDriverSelect" onchange="loadDriverData()">
                    <option value="">-- SELECT DRIVER TO EDIT --</option>
                </select>
            </div>

            <div id="editor-area" style="display:none;">
                <div class="track-grid" id="trackGrid"></div>
                <div class="total-box">
                    <div style="color:#888; font-family:'JetBrains Mono'; text-transform:uppercase; letter-spacing:1px;">Calculated Total Points</div>
                    <div class="total-value" id="calculatedTotal">0</div>
                </div>
                <button class="action-btn" onclick="saveAllChanges()">COMMIT CHANGES TO SERVER</button>
                <div id="editor-status" style="text-align:center; margin-top:15px; font-weight:bold; font-family:'JetBrains Mono';"></div>
            </div>
        </div>

        <!-- 2. LIVE VIEW -->
        <div id="live-view" class="section">
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap:30px;">
                <div>
                    <h4 style="color:var(--accent-cyan); border-left:3px solid var(--accent-cyan); padding-left:10px; margin-bottom:15px;">Drivers Championship (<span class="season-display"></span>)</h4>
                    <table class="view-table">
                        <thead><tr><th style="width:10%">#</th><th>DRIVER / TEAM</th><th style="text-align:right">PTS</th></tr></thead>
                        <tbody id="liveDriversBody"></tbody>
                    </table>
                </div>
                <div>
                    <h4 style="color:var(--accent-red); border-left:3px solid var(--accent-red); padding-left:10px; margin-bottom:15px;">Constructors Championship (<span class="season-display"></span>)</h4>
                    <table class="view-table">
                        <thead><tr><th style="width:10%">#</th><th>CONSTRUCTOR</th><th style="text-align:right">PTS</th></tr></thead>
                        <tbody id="liveConstructorsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 3. DRIVER STATISTICS -->
        <div id="driver-stats" class="section">
            <h3 style="color:var(--accent-cyan); margin-bottom:10px;"><i class="fas fa-chart-bar"></i> INDIVIDUAL PERFORMANCE</h3>
            <p style="color:#666; font-family:'JetBrains Mono'; font-size:0.9rem; margin-bottom:20px;">ANALYZE DATA FOR: <span class="season-display" style="color:var(--accent-red); font-weight:bold;"></span></p>
            
            <div class="form-group">
                <select id="statsDriverSelect" onchange="viewDriverStats()">
                    <option value="">-- SELECT DRIVER FOR ANALYSIS --</option>
                </select>
            </div>

            <div id="statsDisplay" style="display:none; animation: fadeIn 0.5s ease-out;">
                <h2 id="statsDriverName" style="color:#fff; margin-bottom:5px;">DRIVER NAME</h2>
                <div id="statsTeamName" style="color:var(--accent-red); font-family:'JetBrains Mono'; margin-bottom:20px;">TEAM NAME</div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-val" id="statPoints">0</div>
                        <div class="stat-label">TOTAL POINTS</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-val" id="statWins">0</div>
                        <div class="stat-label">RACE WINS</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-val" id="statPodiums">0</div>
                        <div class="stat-label">PODIUMS</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-val" id="statAvg">0</div>
                        <div class="stat-label">AVG POINTS</div>
                    </div>
                </div>

                <div class="stats-history-container">
                    <h4 style="color:var(--accent-cyan); margin-bottom:15px;">SEASON HISTORY</h4>
                    <table class="view-table">
                        <thead>
                            <tr>
                                <th>TRACK</th>
                                <th>TEAM USED</th>
                                <th style="text-align:right">POINTS</th>
                            </tr>
                        </thead>
                        <tbody id="statsHistoryBody">
                            <!-- JS Generated -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 4. MANAGE -->
        <div id="manage-drivers" class="section">
            <h3 style="color:var(--accent-cyan); margin-bottom:10px;">DRIVER REGISTRATION</h3>
            <p style="color:#666; font-family:'JetBrains Mono'; font-size:0.9rem; margin-bottom:20px;">ADDING TO: <span class="season-display" style="color:var(--accent-red); font-weight:bold;"></span></p>
            
            <div style="background:var(--glass-bg); padding:20px; border:1px solid #333; margin-bottom:30px;">
                <div class="form-group">
                    <label>Driver Handle / Name</label>
                    <input type="text" id="newDriverName" placeholder="ENTER DRIVER NAME">
                </div>
                <div class="form-group">
                    <label>Contracted Team</label>
                    <select id="newDriverTeam">
                        <option value="red-bull-racing">Red Bull Racing</option>
                        <option value="ferrari">Ferrari</option>
                        <option value="mercedes">Mercedes</option>
                        <option value="mclaren">McLaren</option>
                        <option value="aston-martin">Aston Martin</option>
                        <option value="alpine">Alpine</option>
                        <option value="williams">Williams</option>
                        <option value="racing-bulls">Racing Bulls</option>
                        <option value="kick-sauber">Kick Sauber</option>
                        <option value="haas">Haas</option>
                        <option value="reserve">Reserve / Free Agent</option>
                    </select>
                </div>
                <button class="action-btn" onclick="registerDriver()">ADD TO GRID</button>
                <div id="register-status" style="text-align:center; margin-top:15px; font-family:'JetBrains Mono'; color:var(--accent-cyan);"></div>
            </div>

            <h3 style="margin-bottom:15px;">CURRENT GRID (<span class="season-display"></span>)</h3>
            <div id="driverList" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap:10px;">Loading...</div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ==========================================
        //  1. CONFIGURATION
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyApUD33ao9DfFa8IAfA2qby3IFKhLtcNFU",
            authDomain: "ttrl-9f3ef.firebaseapp.com",
            projectId: "ttrl-9f3ef",
            storageBucket: "ttrl-9f3ef.firebasestorage.app",
            messagingSenderId: "51144639440",
            appId: "1:51144639440:web:8a027b773bc2cddefe2fd5"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let currentSeason = "season_1"; 
        let unsubscribe = null; 
        let knownSeasons = JSON.parse(localStorage.getItem('ttrl_seasons')) || ['season_1'];

        // --- CONSTANTS ---
        const TRACKS = [
            {id:'bahrain', name:'Bahrain'}, {id:'australia', name:'Australia'}, {id:'imola', name:'Imola'},
            {id:'spain', name:'Spain'}, {id:'uk', name:'Great Britain'}, {id:'vegas', name:'Las Vegas'},
            {id:'belgium', name:'Belgium'}, {id:'austria', name:'Austria'}, {id:'brazil', name:'Brazil'},
            {id:'abu_dhabi', name:'Abu Dhabi'}
        ];

        const TEAMS = [
            {id:'red-bull-racing', name:'Red Bull'}, {id:'ferrari', name:'Ferrari'}, {id:'mercedes', name:'Mercedes'},
            {id:'mclaren', name:'McLaren'}, {id:'aston-martin', name:'Aston Martin'}, {id:'alpine', name:'Alpine'},
            {id:'williams', name:'Williams'}, {id:'racing-bulls', name:'Racing Bulls'}, {id:'kick-sauber', name:'Kick Sauber'},
            {id:'haas', name:'Haas'}, {id:'reserve', name:'Reserve'}
        ];

        let driversCache = {};
        let allDrivers = [];

        // --- AUTHENTICATION LOGIC ---
        window.checkLogin = () => {
            const email = document.getElementById("loginEmail").value;
            const pass = document.getElementById("loginPass").value;

            signInWithEmailAndPassword(auth, email, pass)
                .catch((error) => {
                    document.getElementById("login-msg").innerText = "ACCESS DENIED: " + error.message;
                });
        };

        window.loginWithGoogle = () => {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider)
                .catch((error) => {
                    document.getElementById("login-msg").innerText = "GOOGLE AUTH FAILED: " + error.message;
                });
        };

        window.logout = () => {
            signOut(auth).then(() => {
                window.location.reload();
            });
        };

        // Auth State Listener (The Gatekeeper)
        onAuthStateChanged(auth, (user) => {
            const overlay = document.getElementById("login-overlay");
            
            if (user) {
                // ACCESS GRANTED
                overlay.style.display = "none";
                document.getElementById("main-interface").style.display = "block";
                
                // Update User Badge
                const name = user.displayName || user.email.split('@')[0];
                document.getElementById("userName").innerText = name.toUpperCase(); 
                
                // Start App
                renderKnownSeasons();
                changeSeason(); 
            } else {
                // Not logged in
                overlay.style.display = "flex";
                document.getElementById("main-interface").style.display = "none";
            }
        });

        // --- UI HELPERS ---
        window.switchTab = (id) => {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            event.target.classList.add('active');
        };

        function renderKnownSeasons() {
            const container = document.getElementById("knownSeasonsList");
            container.innerHTML = "QUICK LOAD: " + knownSeasons.map(s => 
                `<span class="season-tag" onclick="selectSeason('${s}')">${s}</span>`
            ).join(' ');
        }

        window.selectSeason = (sid) => {
            document.getElementById("seasonInput").value = sid;
            changeSeason();
        };

        // --- CORE DATA LOGIC ---
        window.changeSeason = () => {
            const inputVal = document.getElementById("seasonInput").value.trim().toLowerCase().replace(/\s+/g, '_');
            if(!inputVal) return;
            
            currentSeason = inputVal;
            
            if(!knownSeasons.includes(currentSeason)) {
                knownSeasons.push(currentSeason);
                localStorage.setItem('ttrl_seasons', JSON.stringify(knownSeasons));
                renderKnownSeasons();
            }
            
            document.getElementById("currentSeasonLabel").innerText = currentSeason;
            document.querySelectorAll(".season-display").forEach(el => el.innerText = currentSeason);

            document.getElementById("editorDriverSelect").innerHTML = '<option value="">-- SELECT DRIVER TO EDIT --</option>';
            document.getElementById("driverList").innerHTML = "Loading...";
            document.getElementById("editor-area").style.display = "none";
            
            initListener(); 
        };

        function initListener() {
            if(unsubscribe) unsubscribe(); 
            const colRef = collection(db, "seasons", currentSeason, "drivers");
            const q = query(colRef, orderBy("totalPoints", "desc"));

            unsubscribe = onSnapshot(q, (snap) => {
                const select = document.getElementById("editorDriverSelect");
                const list = document.getElementById("driverList");
                const statsSelect = document.getElementById("statsDriverSelect");
                
                select.innerHTML = '<option value="">-- SELECT DRIVER TO EDIT --</option>';
                statsSelect.innerHTML = '<option value="">-- SELECT DRIVER FOR ANALYSIS --</option>';
                list.innerHTML = "";
                allDrivers = [];

                if(snap.empty) {
                    list.innerHTML = `<div style="padding:20px; text-align:center; color:#888; grid-column: 1/-1;">NO DRIVERS FOUND IN ${currentSeason.toUpperCase()} DATABASE.</div>`;
                }

                snap.forEach(doc => {
                    const data = doc.data();
                    data.id = doc.id;
                    driversCache[doc.id] = data;
                    allDrivers.push(data);

                    // Populate Editor Dropdown
                    const opt = document.createElement("option");
                    opt.value = doc.id;
                    opt.text = `${data.name.toUpperCase()} // ${data.team.toUpperCase().replace('-',' ')}`;
                    select.appendChild(opt);

                    // Populate Stats Dropdown
                    const statsOpt = document.createElement("option");
                    statsOpt.value = doc.id;
                    statsOpt.text = `${data.name.toUpperCase()}`;
                    statsSelect.appendChild(statsOpt);

                    // Populate Grid List
                    const div = document.createElement("div");
                    div.className = "driver-item";
                    div.innerHTML = `
                        <div>
                            <div style="font-weight:bold; color:#fff;">${data.name}</div> 
                            <small style="color:var(--accent-cyan); letter-spacing:1px; text-transform:uppercase;">${data.team}</small>
                        </div> 
                        <button class="delete-btn" onclick="deleteDriver('${doc.id}', '${data.name}')"><i class="fas fa-trash"></i> DELETE</button>`;
                    list.appendChild(div);
                });

                updateLiveTables();
                
                // If a driver is currently selected in stats view, refresh their view
                const currentStatDriverId = document.getElementById("statsDriverSelect").value;
                if(currentStatDriverId) viewDriverStats();
            });
        }

        window.loadDriverData = () => {
            const id = document.getElementById("editorDriverSelect").value;
            const grid = document.getElementById("trackGrid");
            const area = document.getElementById("editor-area");
            
            if(!id) { area.style.display = "none"; return; }
            area.style.display = "block";
            grid.innerHTML = "";

            const data = driversCache[id];
            const results = data.results || {};

            TRACKS.forEach(t => {
                let pts = 0;
                let team = data.team; 
                if(results[t.id]) {
                    if(typeof results[t.id] === 'object') {
                        pts = results[t.id].points || 0;
                        team = results[t.id].team || data.team;
                    } else {
                        pts = results[t.id]; 
                    }
                }
                let teamOpts = TEAMS.map(tm => `<option value="${tm.id}" ${tm.id === team ? 'selected':''}>${tm.name}</option>`).join('');
                const div = document.createElement("div");
                div.className = "track-input";
                div.innerHTML = `<label>${t.name}</label><div class="row-inputs"><input type="number" class="points-input" data-track="${t.id}" value="${pts}" oninput="calcTotal()"><select class="team-input" id="team-${t.id}">${teamOpts}</select></div>`;
                grid.appendChild(div);
            });
            calcTotal();
        };

        window.calcTotal = () => {
            let sum = 0;
            document.querySelectorAll(".points-input").forEach(i => sum += Number(i.value) || 0);
            document.getElementById("calculatedTotal").innerText = sum;
        };

        window.saveAllChanges = async () => {
            const id = document.getElementById("editorDriverSelect").value;
            const status = document.getElementById("editor-status");
            const pointsInputs = document.querySelectorAll(".points-input");
            const teamInputs = document.querySelectorAll(".team-input");
            
            status.innerText = "UPLOADING TO SERVER...";
            status.style.color = "#ccc";
            let newResults = {};
            let newTotal = 0;

            pointsInputs.forEach((input, idx) => {
                const val = Number(input.value);
                const track = input.dataset.track;
                const team = teamInputs[idx].value;
                if(val > 0) {
                    newResults[track] = { points: val, team: team };
                    newTotal += val;
                }
            });

            try {
                const docRef = doc(db, "seasons", currentSeason, "drivers", id);
                await updateDoc(docRef, { results: newResults, totalPoints: newTotal });
                status.style.color = "var(--accent-cyan)";
                status.innerText = "✓ DATABASE UPDATED SUCCESSFULLY";
                setTimeout(() => status.innerText = "", 2000);
            } catch(e) {
                console.error(e);
                status.style.color = "var(--accent-red)";
                status.innerText = "ERROR: " + e.message;
            }
        };

        // --- STATS LOGIC ---
        window.viewDriverStats = () => {
            const id = document.getElementById("statsDriverSelect").value;
            const display = document.getElementById("statsDisplay");
            
            if(!id) { display.style.display = "none"; return; }
            display.style.display = "block";

            const data = driversCache[id];
            const results = data.results || {};
            
            // Basic Info
            document.getElementById("statsDriverName").innerText = data.name.toUpperCase();
            document.getElementById("statsTeamName").innerText = TEAMS.find(t => t.id === data.team)?.name.toUpperCase() || data.team;
            document.getElementById("statPoints").innerText = data.totalPoints;

            // Calculations
            let wins = 0;
            let podiums = 0;
            let racesParticipated = 0;
            let tableHTML = "";

            TRACKS.forEach(track => {
                const res = results[track.id];
                if(res) {
                    const pts = typeof res === 'object' ? res.points : res;
                    const tmId = typeof res === 'object' ? res.team : data.team;
                    const tmName = TEAMS.find(t => t.id === tmId)?.name || tmId;
                    
                    if(pts > 0) {
                        racesParticipated++;
                        if(pts >= 25) wins++; // Simplified Win check (Standard F1 is 25)
                        if(pts >= 15) podiums++; // Simplified Podium (15 is 3rd place)
                        
                        tableHTML += `
                            <tr>
                                <td style="color:#fff; font-weight:bold;">${track.name.toUpperCase()}</td>
                                <td style="color:#888; text-transform:uppercase;">${tmName}</td>
                                <td style="text-align:right; font-weight:bold; color:var(--accent-cyan);">${pts}</td>
                            </tr>
                        `;
                    }
                }
            });

            document.getElementById("statWins").innerText = wins;
            document.getElementById("statPodiums").innerText = podiums;
            document.getElementById("statAvg").innerText = racesParticipated > 0 ? (data.totalPoints / racesParticipated).toFixed(1) : "0.0";
            
            if(tableHTML === "") tableHTML = `<tr><td colspan="3" style="text-align:center; padding:20px; color:#666;">NO DATA RECORDED</td></tr>`;
            document.getElementById("statsHistoryBody").innerHTML = tableHTML;
        };

        function updateLiveTables() {
            const dTable = document.getElementById("liveDriversBody");
            dTable.innerHTML = "";
            
            // Sorting Logic: Regular drivers first (by points desc), then Reserves (by points desc)
            const sortedDrivers = [...allDrivers].sort((a, b) => {
                const isReserveA = a.team === 'reserve';
                const isReserveB = b.team === 'reserve';
                
                if (isReserveA && !isReserveB) return 1; // A is reserve -> move down
                if (!isReserveA && isReserveB) return -1; // B is reserve -> move down
                
                return b.totalPoints - a.totalPoints; // Descending Points
            });

            sortedDrivers.forEach((d, i) => {
                let teamDisplay = TEAMS.find(t => t.id === d.team)?.name || d.team;
                if(d.team === 'reserve') teamDisplay = "Reserve"; 
                dTable.innerHTML += `<tr><td style="color:#666">${String(i+1).padStart(2,'0')}</td><td><div style="font-weight:bold; color:#fff;">${d.name}</div><div style="font-size:0.75rem; color:var(--accent-cyan); text-transform:uppercase; letter-spacing:1px;">${teamDisplay}</div></td><td style="text-align:right; font-weight:bold; font-size:1.1rem; color:var(--accent-cyan)">${d.totalPoints}</td></tr>`;
            });

            const teamPoints = {};
            allDrivers.forEach(d => {
                const results = d.results || {};
                Object.values(results).forEach(r => {
                    let p = 0, t = d.team; 
                    if(typeof r === 'object') { p = r.points || 0; t = r.team || d.team; } else { p = r; }
                    if(t !== 'reserve') {
                        if(!teamPoints[t]) teamPoints[t] = 0;
                        teamPoints[t] += p;
                    }
                });
            });
            const sortedTeams = Object.keys(teamPoints).map(k => ({name: k, pts: teamPoints[k]})).sort((a,b) => b.pts - a.pts);
            const cTable = document.getElementById("liveConstructorsBody");
            cTable.innerHTML = "";
            sortedTeams.forEach((tm, i) => {
                const prettyName = TEAMS.find(t => t.id === tm.name)?.name || tm.name;
                cTable.innerHTML += `<tr><td style="color:#666">${String(i+1).padStart(2,'0')}</td><td style="text-transform:uppercase; font-weight:bold; color:#fff;">${prettyName}</td><td style="text-align:right; font-weight:bold; color:var(--accent-red)">${tm.pts}</td></tr>`;
            });
        }

        window.registerDriver = async () => {
            const name = document.getElementById("newDriverName").value;
            const team = document.getElementById("newDriverTeam").value;
            if(!name) return;
            try {
                const colRef = collection(db, "seasons", currentSeason, "drivers");
                await addDoc(colRef, { name, team, totalPoints: 0, results: {} });
                document.getElementById("newDriverName").value = "";
                document.getElementById("register-status").innerText = "✓ DRIVER ADDED TO GRID";
                setTimeout(() => document.getElementById("register-status").innerText = "", 2000);
            } catch(e) { console.error(e); }
        };

        window.deleteDriver = async (id, name) => {
            if(confirm(`CONFIRM DELETION:\n\nRemove ${name} from ${currentSeason} database?\nThis action cannot be undone.`)) {
                await deleteDoc(doc(db, "seasons", currentSeason, "drivers", id));
            }
        };
    </script>
</body>
</html>
