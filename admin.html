<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TTRL Pitwall</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --bg: #0b0c10; --card: #1f2833; --accent: #66fcf1; --text: #c5c6c7; --red: #ff1f4b; }
        body { background: var(--bg); color: var(--text); font-family: 'Rajdhani', sans-serif; margin: 0; padding: 20px; }
        
        /* LOGIN OVERLAY */
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 999; display: flex; justify-content: center; align-items: center; transition: opacity 0.5s; }
        .login-box { background: var(--card); padding: 2rem; border-radius: 8px; text-align: center; border: 1px solid #333; width: 300px; box-shadow: 0 0 30px rgba(102, 252, 241, 0.1); }
        
        /* LAYOUT */
        .container { max-width: 900px; margin: 0 auto; display: none; }
        header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--accent); padding-bottom: 10px; margin-bottom: 20px; }
        h1 { margin: 0; color: var(--accent); text-transform: uppercase; }
        
        /* TABS */
        .nav-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { flex: 1; padding: 15px; background: var(--card); border: none; color: #fff; cursor: pointer; font-family: 'Rajdhani', sans-serif; font-size: 1.2rem; font-weight: bold; text-transform: uppercase; transition: 0.3s; clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px); }
        .tab-btn:hover { background: #2c3e50; }
        .tab-btn.active { background: var(--accent); color: #000; }

        /* SECTIONS */
        .section { display: none; background: var(--card); padding: 20px; border-radius: 8px; animation: fadeIn 0.3s ease; }
        .section.active { display: block; }
        
        /* FORMS */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; color: #888; font-size: 0.9rem; }
        input, select { width: 100%; padding: 12px; background: #0b0c10; border: 1px solid #45a29e; color: #fff; font-family: inherit; font-size: 1rem; box-sizing: border-box; }
        input:focus, select:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 10px rgba(102, 252, 241, 0.2); }

        /* TRACK GRID */
        .track-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; margin-top: 20px; }
        .track-input { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 5px; border: 1px solid #333; }
        .track-input label { color: var(--accent); font-size: 0.8rem; text-transform: uppercase; margin-bottom: 5px; display: block; }
        .track-input input { width: 100%; padding: 8px; font-size: 1.1rem; text-align: center; border: 1px solid #444; }
        
        /* TOTAL BOX */
        .total-box { margin-top: 20px; padding: 15px; background: #000; border-left: 4px solid var(--accent); display: flex; justify-content: space-between; align-items: center; }
        .total-label { color: #888; text-transform: uppercase; letter-spacing: 1px; }
        .total-value { font-size: 2rem; font-weight: bold; color: #fff; }

        button.action-btn { width: 100%; padding: 15px; background: var(--accent); color: #0b0c10; border: none; font-weight: 800; font-size: 1.1rem; cursor: pointer; text-transform: uppercase; margin-top: 20px; transition: 0.2s; }
        button.action-btn:hover { background: #fff; transform: translateY(-2px); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        button.delete-btn { background: var(--red); color: white; border: none; padding: 5px 10px; cursor: pointer; font-size: 0.8rem; }

        /* LIST */
        .driver-item { display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.3); padding: 10px; margin-bottom: 5px; border-left: 3px solid #555; }
        .team-badge { font-size: 0.8rem; padding: 2px 6px; background: #333; margin-left: 10px; color: #aaa; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: 0; } }
        .status { margin-top: 10px; text-align: center; font-weight: bold; min-height: 20px; }
        .success { color: #00ff00; } .error { color: #ff0000; }
    </style>
</head>
<body>

    <!-- LOGIN SCREEN -->
    <div id="login-overlay">
        <div class="login-box">
            <h2><i class="fas fa-lock"></i> PITWALL ACCESS</h2>
            <div class="form-group">
                <input type="password" id="adminPass" placeholder="Enter Password">
            </div>
            <button class="action-btn" onclick="checkLogin()">UNLOCK</button>
            <div id="login-msg" class="status error"></div>
        </div>
    </div>

    <!-- MAIN INTERFACE -->
    <div class="container" id="main-interface">
        <header>
            <h1>TTRL Admin</h1>
            <div style="font-size: 0.8rem; color: #666;">v3.0 (Full Editor)</div>
        </header>

        <div class="nav-tabs">
            <button class="tab-btn active" onclick="switchTab('race-control')">Results Editor</button>
            <button class="tab-btn" onclick="switchTab('manage-drivers')">Manage Drivers</button>
        </div>

        <!-- TAB 1: FULL EDITOR -->
        <div id="race-control" class="section active">
            <h3><i class="fas fa-edit"></i> Edit Driver Results</h3>
            <p style="color:#888; font-size:0.9rem;">Select a driver to load their scorecard. Enter '0' or leave blank if no points.</p>
            
            <div class="form-group">
                <label>Select Driver</label>
                <select id="editorDriverSelect" onchange="loadDriverData()">
                    <option value="">-- Select Driver --</option>
                </select>
            </div>

            <div id="editor-area" style="display:none;">
                <div class="track-grid" id="trackGrid">
                    <!-- Inputs injected by JS -->
                </div>

                <div class="total-box">
                    <div class="total-label">Calculated Season Total</div>
                    <div class="total-value" id="calculatedTotal">0</div>
                </div>

                <button class="action-btn" onclick="saveAllChanges()">SAVE CHANGES</button>
                <div id="editor-status" class="status"></div>
            </div>
        </div>

        <!-- TAB 2: MANAGE DRIVERS -->
        <div id="manage-drivers" class="section">
            <h3><i class="fas fa-user-plus"></i> Register New Driver</h3>
            
            <div class="form-group">
                <label>Driver Name</label>
                <input type="text" id="newDriverName" placeholder="Gamertag / Name">
            </div>

            <div class="form-group">
                <label>Team</label>
                <select id="newDriverTeam">
                    <option value="red-bull-racing">Red Bull Racing</option>
                    <option value="ferrari">Ferrari</option>
                    <option value="mercedes">Mercedes</option>
                    <option value="mclaren">McLaren</option>
                    <option value="aston-martin">Aston Martin</option>
                    <option value="alpine">Alpine</option>
                    <option value="williams">Williams</option>
                    <option value="racing-bulls">Racing Bulls</option>
                    <option value="kick-sauber">Kick Sauber</option>
                    <option value="haas">Haas</option>
                    <option value="reserve">Reserve / Free Agent</option>
                </select>
            </div>

            <button class="action-btn" style="background-color: #45a29e;" onclick="registerDriver()">Create Driver Profile</button>
            <div id="register-status" class="status"></div>

            <hr style="border-color: #333; margin: 30px 0;">

            <h3><i class="fas fa-users"></i> Driver Database</h3>
            <div id="driverList">
                <div style="text-align:center; padding:20px;">Waiting for login...</div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, getDoc, doc, updateDoc, deleteDoc, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ==========================================
        //  FIREBASE CONFIG
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyApUD33ao9DfFa8IAfA2qby3IFKhLtcNFU",
            authDomain: "ttrl-9f3ef.firebaseapp.com",
            projectId: "ttrl-9f3ef",
            storageBucket: "ttrl-9f3ef.firebasestorage.app",
            messagingSenderId: "51144639440",
            appId: "1:51144639440:web:8a027b773bc2cddefe2fd5"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const collectionName = "standings";

        // --- TTRL CALENDAR DEFINITION ---
        const TRACK_LIST = [
            { id: 'bahrain', name: 'Bahrain GP' },
            { id: 'australia', name: 'Australia GP' },
            { id: 'imola', name: 'Imola GP' },
            { id: 'spain', name: 'Spain GP' },
            { id: 'uk', name: 'Great Britain GP' },
            { id: 'vegas', name: 'Las Vegas GP' },
            { id: 'belgium', name: 'Belgium GP' },
            { id: 'austria', name: 'Austria GP' },
            { id: 'brazil', name: 'Brazil GP' },
            { id: 'abu_dhabi', name: 'Abu Dhabi GP' }
        ];

        // --- AUTH & SETUP ---
        window.checkLogin = () => {
            const pass = document.getElementById("adminPass").value;
            if(pass === "admin123") { 
                document.getElementById("login-overlay").style.display = "none";
                document.getElementById("main-interface").style.display = "block";
                initRealtimeListeners();
            } else {
                document.getElementById("login-msg").innerText = "ACCESS DENIED";
            }
        };

        window.switchTab = (tabId) => {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
        };

        // --- GLOBAL DATA ---
        let driversCache = {}; // Store data locally for quick access

        // 1. Listen to Database
        function initRealtimeListeners() {
            const q = query(collection(db, collectionName), orderBy("totalPoints", "desc"));
            
            onSnapshot(q, (snapshot) => {
                const driverSelect = document.getElementById("editorDriverSelect");
                const driverList = document.getElementById("driverList");
                
                // Only clear if empty to prevent UI jumping while typing
                if(driverSelect.options.length <= 1) {
                    driverSelect.innerHTML = '<option value="">-- Select Driver --</option>';
                }
                driverList.innerHTML = '';

                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const id = docSnap.id;
                    driversCache[id] = data; // Cache data

                    // Populate Dropdown (check if exists to avoid dupes)
                    if(!document.querySelector(`option[value="${id}"]`)) {
                        const option = document.createElement("option");
                        option.value = id;
                        option.text = `${data.name} (${data.team})`;
                        driverSelect.appendChild(option);
                    }

                    // Populate List
                    const item = document.createElement("div");
                    item.className = "driver-item";
                    item.innerHTML = `
                        <div><strong>${data.name}</strong> <span class="team-badge">${data.team}</span> <span style="color:var(--accent)">${data.totalPoints} pts</span></div>
                        <button class="delete-btn" onclick="deleteDriver('${id}', '${data.name}')">DELETE</button>
                    `;
                    driverList.appendChild(item);
                });
            });
        }

        // 2. Load Driver Data into Grid
        window.loadDriverData = () => {
            const driverId = document.getElementById("editorDriverSelect").value;
            const editorArea = document.getElementById("editor-area");
            const grid = document.getElementById("trackGrid");

            if(!driverId) {
                editorArea.style.display = "none";
                return;
            }

            editorArea.style.display = "block";
            grid.innerHTML = ""; // Clear old inputs

            const driverData = driversCache[driverId];
            const results = driverData.results || {};

            // Generate Input for EVERY track
            TRACK_LIST.forEach(track => {
                const points = results[track.id] || 0; // Default to 0 if empty
                
                const div = document.createElement("div");
                div.className = "track-input";
                div.innerHTML = `
                    <label>${track.name}</label>
                    <input type="number" 
                           class="points-input" 
                           data-track="${track.id}" 
                           value="${points}" 
                           oninput="calculateLiveTotal()">
                `;
                grid.appendChild(div);
            });

            calculateLiveTotal(); // Run once to set initial sum
        };

        // 3. Live Calculator (Client Side)
        window.calculateLiveTotal = () => {
            const inputs = document.querySelectorAll(".points-input");
            let sum = 0;
            inputs.forEach(input => {
                sum += Number(input.value) || 0;
            });
            document.getElementById("calculatedTotal").innerText = sum;
        };

        // 4. Save ALL Data (The Fix)
        window.saveAllChanges = async () => {
            const driverId = document.getElementById("editorDriverSelect").value;
            const status = document.getElementById("editor-status");
            const inputs = document.querySelectorAll(".points-input");
            
            status.innerText = "Saving...";
            
            let newResults = {};
            let newTotal = 0;

            // Build new results object from inputs
            inputs.forEach(input => {
                const trackId = input.dataset.track;
                const val = Number(input.value);
                if(val > 0) {
                    newResults[trackId] = val;
                    newTotal += val;
                }
            });

            try {
                const driverRef = doc(db, collectionName, driverId);
                
                // OVERWRITE results and UPDATE total
                // This fixes the "increment" bug by setting the absolute correct value
                await updateDoc(driverRef, {
                    results: newResults,
                    totalPoints: newTotal
                });

                status.className = "status success";
                status.innerText = `Saved! New Total: ${newTotal} pts`;
            } catch (e) {
                console.error(e);
                status.className = "status error";
                status.innerText = "Error saving data.";
            }
        };

        // 5. Register New Driver
        window.registerDriver = async () => {
            const name = document.getElementById("newDriverName").value;
            const team = document.getElementById("newDriverTeam").value;
            const status = document.getElementById("register-status");

            if(!name) return;
            status.innerText = "Adding...";
            
            try {
                await addDoc(collection(db, collectionName), {
                    name: name,
                    team: team,
                    totalPoints: 0,
                    results: {}, 
                    notes: ""
                });
                status.className = "status success";
                status.innerText = "Driver Created!";
                document.getElementById("newDriverName").value = ""; 
            } catch (e) {
                status.className = "status error";
                status.innerText = "Error creating driver.";
            }
        };

        // 6. Delete
        window.deleteDriver = async (id, name) => {
            if(confirm(`Delete ${name}?`)) {
                await deleteDoc(doc(db, collectionName, id));
            }
        };
    </script>
</body>
</html>
